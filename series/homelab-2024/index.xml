<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>HomeLab 2024 on Keep calm and Write something</title><link>https://cychong47.github.io/series/homelab-2024/</link><description>Recent content in HomeLab 2024 on Keep calm and Write something</description><generator>Hugo</generator><language>en-us</language><lastBuildDate>Tue, 20 Feb 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://cychong47.github.io/series/homelab-2024/index.xml" rel="self" type="application/rss+xml"/><item><title>Monitoring Cilium and Hubble with Prometheus and Grafana</title><link>https://cychong47.github.io/post/2024/2024-02-20-cilium-and-hubble-with-prometheus-and-grafana/</link><pubDate>Tue, 20 Feb 2024 00:00:00 +0000</pubDate><guid>https://cychong47.github.io/post/2024/2024-02-20-cilium-and-hubble-with-prometheus-and-grafana/</guid><description>&lt;h2 id="setup-prometheus-and-grafana-to-scrap-cilium-metrics"&gt;Setup Prometheus and Grafana to scrap Cilium metrics&lt;/h2&gt;
&lt;p&gt;This will create a new namespace &lt;code&gt;cilium-monitoring&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sh" data-lang="sh"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.15.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="some-warnings"&gt;Some warnings&amp;hellip;&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sh" data-lang="sh"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;namespace/cilium-monitoring created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;serviceaccount/prometheus-k8s created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;configmap/grafana-config created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;configmap/grafana-cilium-dashboard created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;configmap/grafana-cilium-operator-dashboard created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;configmap/grafana-hubble-dashboard created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;configmap/grafana-hubble-l7-http-metrics-by-workload created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;configmap/prometheus created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;clusterrole.rbac.authorization.k8s.io/prometheus created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;clusterrolebinding.rbac.authorization.k8s.io/prometheus created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;service/grafana created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;service/prometheus created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Warning: would violate PodSecurity &lt;span style="color:#e6db74"&gt;&amp;#34;restricted:latest&amp;#34;&lt;/span&gt;: allowPrivilegeEscalation !&lt;span style="color:#f92672"&gt;=&lt;/span&gt; false &lt;span style="color:#f92672"&gt;(&lt;/span&gt;container &lt;span style="color:#e6db74"&gt;&amp;#34;grafana-core&amp;#34;&lt;/span&gt; must set securityContext.allowPrivilegeEscalation&lt;span style="color:#f92672"&gt;=&lt;/span&gt;false&lt;span style="color:#f92672"&gt;)&lt;/span&gt;, unrestricted capabilities &lt;span style="color:#f92672"&gt;(&lt;/span&gt;container &lt;span style="color:#e6db74"&gt;&amp;#34;grafana-core&amp;#34;&lt;/span&gt; must set securityContext.capabilities.drop&lt;span style="color:#f92672"&gt;=[&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;ALL&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;])&lt;/span&gt;, runAsNonRoot !&lt;span style="color:#f92672"&gt;=&lt;/span&gt; true &lt;span style="color:#f92672"&gt;(&lt;/span&gt;pod or container &lt;span style="color:#e6db74"&gt;&amp;#34;grafana-core&amp;#34;&lt;/span&gt; must set securityContext.runAsNonRoot&lt;span style="color:#f92672"&gt;=&lt;/span&gt;true&lt;span style="color:#f92672"&gt;)&lt;/span&gt;, seccompProfile &lt;span style="color:#f92672"&gt;(&lt;/span&gt;pod or container &lt;span style="color:#e6db74"&gt;&amp;#34;grafana-core&amp;#34;&lt;/span&gt; must set securityContext.seccompProfile.type to &lt;span style="color:#e6db74"&gt;&amp;#34;RuntimeDefault&amp;#34;&lt;/span&gt; or &lt;span style="color:#e6db74"&gt;&amp;#34;Localhost&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;deployment.apps/grafana created
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Warning: would violate PodSecurity &lt;span style="color:#e6db74"&gt;&amp;#34;restricted:latest&amp;#34;&lt;/span&gt;: allowPrivilegeEscalation !&lt;span style="color:#f92672"&gt;=&lt;/span&gt; false &lt;span style="color:#f92672"&gt;(&lt;/span&gt;container &lt;span style="color:#e6db74"&gt;&amp;#34;prometheus&amp;#34;&lt;/span&gt; must set securityContext.allowPrivilegeEscalation&lt;span style="color:#f92672"&gt;=&lt;/span&gt;false&lt;span style="color:#f92672"&gt;)&lt;/span&gt;, unrestricted capabilities &lt;span style="color:#f92672"&gt;(&lt;/span&gt;container &lt;span style="color:#e6db74"&gt;&amp;#34;prometheus&amp;#34;&lt;/span&gt; must set securityContext.capabilities.drop&lt;span style="color:#f92672"&gt;=[&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;ALL&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;])&lt;/span&gt;, runAsNonRoot !&lt;span style="color:#f92672"&gt;=&lt;/span&gt; true &lt;span style="color:#f92672"&gt;(&lt;/span&gt;pod or container &lt;span style="color:#e6db74"&gt;&amp;#34;prometheus&amp;#34;&lt;/span&gt; must set securityContext.runAsNonRoot&lt;span style="color:#f92672"&gt;=&lt;/span&gt;true&lt;span style="color:#f92672"&gt;)&lt;/span&gt;, seccompProfile &lt;span style="color:#f92672"&gt;(&lt;/span&gt;pod or container &lt;span style="color:#e6db74"&gt;&amp;#34;prometheus&amp;#34;&lt;/span&gt; must set securityContext.seccompProfile.type to &lt;span style="color:#e6db74"&gt;&amp;#34;RuntimeDefault&amp;#34;&lt;/span&gt; or &lt;span style="color:#e6db74"&gt;&amp;#34;Localhost&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;deployment.apps/prometheus created
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="kubectl-get-all"&gt;kubectl get all&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sh" data-lang="sh"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;❯ kubectl get all -n cilium-monitoring 
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;NAME READY STATUS RESTARTS AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/grafana-6f4755f98c-8c7sg 1/1 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 57s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pod/prometheus-67fdcf4796-vc8hd 1/1 Running &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; 57s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span style="color:#f92672"&gt;(&lt;/span&gt;S&lt;span style="color:#f92672"&gt;)&lt;/span&gt; AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;service/grafana ClusterIP 10.102.147.187 &amp;lt;none&amp;gt; 3000/TCP 57s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;service/prometheus ClusterIP 10.104.8.139 &amp;lt;none&amp;gt; 9090/TCP 57s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;deployment.apps/grafana 1/1 &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; 57s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;deployment.apps/prometheus 1/1 &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; 57s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;NAME DESIRED CURRENT READY AGE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;replicaset.apps/grafana-6f4755f98c &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; 57s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;replicaset.apps/prometheus-67fdcf4796 &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; 57s
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="change-service-type-to-loadbalancer"&gt;Change service type to LoadBalancer&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sh" data-lang="sh"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;❯ kubectl patch svc prometheus -n cilium-monitoring -p &lt;span style="color:#e6db74"&gt;&amp;#39;{&amp;#34;spec&amp;#34;: {&amp;#34;type&amp;#34;: &amp;#34;LoadBalancer&amp;#34;}}&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;❯ kubectl patch svc grafana -n cilium-monitoring -p &lt;span style="color:#e6db74"&gt;&amp;#39;{&amp;#34;spec&amp;#34;: {&amp;#34;type&amp;#34;: &amp;#34;LoadBalancer&amp;#34;}}&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now &lt;code&gt;TYPE&lt;/code&gt; is &lt;code&gt;LoadBalancer&lt;/code&gt; and &lt;code&gt;EXTERNAL-IP&lt;/code&gt; is assigned for each service&lt;/p&gt;</description></item></channel></rss>