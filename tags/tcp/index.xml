<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Tcp on Keep calm and Write something</title><link>https://cychong47.github.io/tags/tcp/</link><description>Recent content in Tcp on Keep calm and Write something</description><generator>Hugo</generator><language>en-us</language><lastBuildDate>Sun, 01 Apr 2018 02:38:51 +0000</lastBuildDate><atom:link href="https://cychong47.github.io/tags/tcp/index.xml" rel="self" type="application/rss+xml"/><item><title>Google's Load Balancer</title><link>https://cychong47.github.io/post/2017/googles-load-balancer/</link><pubDate>Sun, 01 Oct 2017 08:34:30 +0900</pubDate><guid>https://cychong47.github.io/post/2017/googles-load-balancer/</guid><description>&lt;h1 id="maglev"&gt;Maglev&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Google( &lt;a href="https://research.google.com/pubs/pub44824.html"&gt;https://research.google.com/pubs/pub44824.html&lt;/a&gt; )&lt;/li&gt;
&lt;li&gt;Used in Google Cloud since 2008&lt;/li&gt;
&lt;li&gt;Scalable load balancer
&lt;ul&gt;
&lt;li&gt;Consistent hashing&lt;/li&gt;
&lt;li&gt;Connection Tracking&lt;/li&gt;
&lt;li&gt;Scale-out model backed by router&amp;rsquo;s ECMP&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Bypass kernel space for performance.&lt;/li&gt;
&lt;li&gt;Support connection persistence&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="network-architecture"&gt;Network Architecture&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;DNS - Routers - Maglevs - Service EndPoints.&lt;/li&gt;
&lt;li&gt;One service is served by one or more VIPs
&lt;ul&gt;
&lt;li&gt;DNS returns VIP considering geolocation and load of location&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;One VIP is served by multiple Maglevs
&lt;ul&gt;
&lt;li&gt;Router use ECMP to select one Maglev&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;One VIP is mapped to multiple Service EndPoints
&lt;ul&gt;
&lt;li&gt;Maglev select Service EndPoint by seletion algorithm and connection tracking table&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Maglev use GRE to send incoming packet to Service EndPoint or another Maglev
&lt;ul&gt;
&lt;li&gt;Send to IP fragment to another special Maglev servers&lt;/li&gt;
&lt;li&gt;Use only 3-tuple for IP fragment&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Each Service EndPoint use Direct Server Return(DSR)&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="maglev-1"&gt;Maglev&lt;/h1&gt;
&lt;h2 id="controller"&gt;Controller&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Responsible for VIP announcement with BGP&lt;/li&gt;
&lt;li&gt;Check health status of forwarder&lt;/li&gt;
&lt;li&gt;If forwarder is not headthy, withdraw all VIP announcements&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="forwarder"&gt;Forwarder&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Each VIP has one or multiple backend pools(BP)&lt;/li&gt;
&lt;li&gt;BP contain physical IP address of the Service EndPoint&lt;/li&gt;
&lt;li&gt;Each BP has specific health checking methods - depends on the service requirement(just reachability or more)&lt;/li&gt;
&lt;li&gt;Config Manager parse and update configuration of forwarder&amp;rsquo;s behavior based on the &lt;strong&gt;Config Objects&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Sharding
&lt;ul&gt;
&lt;li&gt;Sharding of Maglev enables service isolation - new service or QoS&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="backend-selection"&gt;Backend Selection&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Consistent Hashing distribute loads&lt;/li&gt;
&lt;li&gt;Record selection in &lt;strong&gt;LOCAL connection tracking table&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;Connection tracking table is &lt;strong&gt;not shared&lt;/strong&gt; with another Maglev&lt;/li&gt;
&lt;li&gt;Does not guarantee consistency on Maglev or Service EndPoint Changes(add/delete)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;For different traffic type
&lt;ul&gt;
&lt;li&gt;TCP SYN : select Backend and record it in connection tracking table&lt;/li&gt;
&lt;li&gt;TCP non-SYN : lookup connection tracking table&lt;/li&gt;
&lt;li&gt;5-tuple : (maybe) lookup connection tracking table and select backend if not found&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="consistent-hashing"&gt;Consistent Hashing&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;If Maglev is added or removed, router select different Maglev for the exsiting session - ECMP is changed&lt;/li&gt;
&lt;li&gt;If one Maglev&amp;rsquo;s local connection tracking table is overflowed, it will lose previous selection&lt;/li&gt;
&lt;li&gt;To resolve this issues,
&lt;ul&gt;
&lt;li&gt;Synchronize local connection tracking table between Maglevs -&amp;gt; overhead, overhead, overhead&lt;/li&gt;
&lt;li&gt;Consistent hashing for minimize disruption in member changes&lt;/li&gt;
&lt;li&gt;Maglev hashing - load balancing and minimal disruption on member changes&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="reference"&gt;reference&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://blog.acolyer.org/2016/03/21/maglev-a-fast-and-reliable-software-network-load-balancer/"&gt;Maglev: A Fast and Reliable Software Network Load Balancer&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://blog.carlosgaldino.com/consistent-hashing.html"&gt;Consistent Hashing&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://dzone.com/articles/simple-magic-consistent"&gt;The Simple Magic of Consistent Hashing&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description></item></channel></rss>