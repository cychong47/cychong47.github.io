<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>How to run DPDK in k8s - One container in each pod | Keep calm and Write something</title><meta name=title content="How to run DPDK in k8s - One container in each pod"><meta name=description content="서로 다른 pod의 container에서 실행되는 DPDK process들도 다른 경우와 마찬가지로 DPDK runtime config 파일과 hugepage map 파일만 공유하면 hugepage를 공유할 수 있다.

이 때 서로 다른 pod가 같은 DPDK runtime config 파일들과, hugepage map 파일을 공유하기 위해 두 개 pod가 함께 사용할 수 있는 hostPath 를 이용한다. hostPath는 pod가 실행되는 node의 파일 시스템을 이용하여 volume을 만든다. 그러므로 서로 다른 pod가 동일 node에서 실행되는 경우에만 pod가 hugepage를 공유할 수 있다."><meta name=keywords content="kubernetes,DPDK,hugepage,"><meta property="og:url" content="https://cychong47.github.io/post/2022/2022-03-14-one-container-in-each-pod/"><meta property="og:site_name" content="Keep calm and Write something"><meta property="og:title" content="How to run DPDK in k8s - One container in each pod"><meta property="og:description" content="서로 다른 pod의 container에서 실행되는 DPDK process들도 다른 경우와 마찬가지로 DPDK runtime config 파일과 hugepage map 파일만 공유하면 hugepage를 공유할 수 있다.
이 때 서로 다른 pod가 같은 DPDK runtime config 파일들과, hugepage map 파일을 공유하기 위해 두 개 pod가 함께 사용할 수 있는 hostPath 를 이용한다. hostPath는 pod가 실행되는 node의 파일 시스템을 이용하여 volume을 만든다. 그러므로 서로 다른 pod가 동일 node에서 실행되는 경우에만 pod가 hugepage를 공유할 수 있다."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-03-14T00:00:03+09:00"><meta property="article:modified_time" content="2022-03-14T00:00:03+09:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="DPDK"><meta property="article:tag" content="Hugepage"><meta property="og:see_also" content="https://cychong47.github.io/post/2022/2022-03-14-two-containers-in-a-pod/"><meta property="og:see_also" content="https://cychong47.github.io/post/2022/2022-03-14-a-single-container-in-a-pod/"><meta property="og:see_also" content="https://cychong47.github.io/post/2022/2022-03-14-hugepage-in-dpdk-basics/"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to run DPDK in k8s - One container in each pod"><meta name=twitter:description content="서로 다른 pod의 container에서 실행되는 DPDK process들도 다른 경우와 마찬가지로 DPDK runtime config 파일과 hugepage map 파일만 공유하면 hugepage를 공유할 수 있다.
이 때 서로 다른 pod가 같은 DPDK runtime config 파일들과, hugepage map 파일을 공유하기 위해 두 개 pod가 함께 사용할 수 있는 hostPath 를 이용한다. hostPath는 pod가 실행되는 node의 파일 시스템을 이용하여 volume을 만든다. 그러므로 서로 다른 pod가 동일 node에서 실행되는 경우에만 pod가 hugepage를 공유할 수 있다."><meta itemprop=name content="How to run DPDK in k8s - One container in each pod"><meta itemprop=description content="서로 다른 pod의 container에서 실행되는 DPDK process들도 다른 경우와 마찬가지로 DPDK runtime config 파일과 hugepage map 파일만 공유하면 hugepage를 공유할 수 있다.
이 때 서로 다른 pod가 같은 DPDK runtime config 파일들과, hugepage map 파일을 공유하기 위해 두 개 pod가 함께 사용할 수 있는 hostPath 를 이용한다. hostPath는 pod가 실행되는 node의 파일 시스템을 이용하여 volume을 만든다. 그러므로 서로 다른 pod가 동일 node에서 실행되는 경우에만 pod가 hugepage를 공유할 수 있다."><meta itemprop=datePublished content="2022-03-14T00:00:03+09:00"><meta itemprop=dateModified content="2022-03-14T00:00:03+09:00"><meta itemprop=wordCount content="764"><meta itemprop=keywords content="Kubernetes,DPDK,Hugepage"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>Keep calm and Write something</h2></a><nav><a href=/post/>Post</a>
<a href=/page/>Page</a>
<a href=/series/>Series</a>
<a href=/tags/>Tag</a>
<a href=/archive/>Archive</a>
<a href=/search/>Search</a></nav></header><main><content><p>서로 다른 pod의 container에서 실행되는 DPDK process들도 다른 경우와 마찬가지로 DPDK runtime config 파일과 hugepage map 파일만 공유하면 hugepage를 공유할 수 있다.</p><p><img src=/images/2022/03/2022-03-14-dpdk-hugepage-1c-2p-1.png alt=2022-03-14-dpdk-hugepage-1c-2p-1.png></p><p>이 때 서로 다른 pod가 같은 DPDK runtime config 파일들과, hugepage map 파일을 공유하기 위해 두 개 pod가 함께 사용할 수 있는 <code>hostPath</code> 를 이용한다. <code>hostPath</code>는 pod가 실행되는 node의 파일 시스템을 이용하여 volume을 만든다. 그러므로 서로 다른 pod가 동일 node에서 실행되는 경우에만 pod가 hugepage를 공유할 수 있다.</p><h3 id=dpdk-runtime-config>DPDK runtime config</h3><p>두 개 pod에서 <code>hostPath</code> 를 이용하여 DPDK runtime config 파일을 공유를 위한 volume을 만든다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dpdk-config</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hostPath</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/tmp/dpdk-config</span>
</span></span></code></pre></div><p>Two containers in a single pod 경우와 마찬가지로, 각 container에서는 위 volume을 <code>/var/run/dpdk</code> 위치에 마운트 시킨다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>container-1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/var/run/dpdk</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dpdk-config</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>container-2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/var/run/dpdk</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dpdk-config</span>
</span></span></code></pre></div><h3 id=hugetlbfs>hugetlbfs</h3><p>서로 다른 pod가 hugetlbfs를 공유하기 위해 host의 <code>hostPath</code> 를 사용한다. 이때 <code>emptyDir</code>을 사용하는 경우와 달리 pod간 공유할 hugetlbfs를 <code>hostPath</code>에서 만들기 위해 node에 이미 <code>hugetlbfs</code>로 마운트 된 경우를 사용해야 한다.</p><p>리눅스에서는 boot 인자로 지정한 default hugepage size에 해당하는 hugepage는 <code>/dev/hugepages</code>에 마운트 된다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /proc/cmdline 
</span></span><span style=display:flex><span>BOOT_IMAGE<span style=color:#f92672>=</span>/boot/vmlinuz-5.13.0-1021-oracle root<span style=color:#f92672>=</span>UUID<span style=color:#f92672>=</span>b69068ad-8c25-4bc9-ae7f-e6f8103b9c97 ro default_hugepagesz<span style=color:#f92672>=</span>2M hugepagesz<span style=color:#f92672>=</span>2M hugepages<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span> console<span style=color:#f92672>=</span>tty1 console<span style=color:#f92672>=</span>ttyS0 nvme.shutdown_timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span> libiscsi.debug_libiscsi_eh<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> crash_kexec_post_notifiers
</span></span></code></pre></div><p>위 경우 <code>default_hugepagesz=2M</code> 옵션을 이용하여 2MB를 default hugepage로 사용한 경우로 이 hugepage 들이 마운트 된 위치를 다음과 같이 확인할 수 있다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ grep hugetlbfs /proc/mounts 
</span></span><span style=display:flex><span>hugetlbfs /dev/hugepages hugetlbfs rw,relatime,pagesize<span style=color:#f92672>=</span>2M <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>pod에서 node의 <code>hugetlbfs</code>를 사용하기 위해 다음과 같이 node의 <code>/dev/hugepages</code> 사용하는 volume을 만든다. (pod에서 별도로 hugetlbfs를 만들지 않고, node에 이미 마운트 된 <code>hugetlbfs</code> 를 사용하므로, <code>emptyDir</code>을 이용한 hugepage를 만들 필요 없다)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dev-hp</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hostPath</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/dev/hugepages</span>
</span></span></code></pre></div><p>그리고 2개 pod내 container들은 각자 이 volume을 자신의 <code>/dev/hugepages</code>에 마운트 한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>container-1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/dev/hugepages</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dev-hp</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>container-2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/dev/hugepages</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dev-hp</span>
</span></span></code></pre></div><p>이제 각 pod 의 container에서 각각 DPDK primary process와 secondary process를 실행시키면 두 개 DPDK process들은 hugepage를 이용하여 DPDK가 제공하는 ring 등을 사용하여 서로 통신할 수 있다.</p><pre tabindex=0><code>root@hugepage-2c-2p-1:~/dpdk# ./dpdk-simple_mp -l 0-1 -n 1 --proc-type=primary
EAL: Detected CPU lcores: 4
EAL: Detected NUMA nodes: 1
EAL: Detected static linkage of DPDK
EAL: Multi-process socket /var/run/dpdk/rte/mp_socket
EAL: Selected IOVA mode &#39;VA&#39;
EAL: No available 32768 kB hugepages reported
EAL: No available 64 kB hugepages reported
EAL: No available 1048576 kB hugepages reported
EAL: Probe PCI driver: net_virtio (1af4:1000) device: 0000:00:03.0 (socket 0)
eth_virtio_pci_init(): Failed to init PCI device
EAL: Requested device 0000:00:03.0 cannot be used
TELEMETRY: No legacy callbacks, legacy socket not created
APP: Finished Process Init.

simple_mp &gt; Starting core 1
</code></pre><pre tabindex=0><code>root@hugepage-2c-2p-2:~/dpdk# ./dpdk-simple_mp -l 2-3 -n 1 --proc-type=secondary
EAL: Detected CPU lcores: 4
EAL: Detected NUMA nodes: 1
EAL: Detected static linkage of DPDK
EAL: Multi-process socket /var/run/dpdk/rte/mp_socket_20_6d504b91042f
EAL: Selected IOVA mode &#39;VA&#39;
EAL: Probe PCI driver: net_virtio (1af4:1000) device: 0000:00:03.0 (socket 0)
Device 0000:00:03.0 is not driven by the primary process
EAL: Requested device 0000:00:03.0 cannot be used
APP: Finished Process Init.

Starting core 3
</code></pre><pre tabindex=0><code>core 1: Received &#39;hi&#39;


simple_mp &gt;
</code></pre><pre tabindex=0><code>simple_mp &gt; send hi

simple_mp &gt;
</code></pre><p>이때 node의 <code>/dev/hugepages</code> 디렉토리를 확인하면 container에서 실행된 DPDK application들이 생성한 hugepage map 파일을 확인할 수 있다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -al /dev/hugepages/
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>2</span> root root       <span style=color:#ae81ff>0</span> Mar <span style=color:#ae81ff>14</span> 14:49 .
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>19</span> root root    <span style=color:#ae81ff>3820</span> Mar <span style=color:#ae81ff>14</span> 09:29 ..
</span></span><span style=display:flex><span>-rw-------  <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>2097152</span> Mar <span style=color:#ae81ff>14</span> 14:50 rtemap_0
</span></span><span style=display:flex><span>-rw-------  <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>2097152</span> Mar <span style=color:#ae81ff>14</span> 14:50 rtemap_1
</span></span></code></pre></div><p>DPDK process의 실행 인자 <code>--file-prefix</code>를 이용하여 hugepage map 파일의 prefix를 변경해 보면 node의 <code>/dev/hugepages</code> 위치에 생성된 hugepage map 파일이 container가 생성한 것을 확인할 수 있다.</p><pre tabindex=0><code>root@hugepage-2c-2p-1:~/dpdk# ./dpdk-simple_mp -l 0-1 -n 1 --proc-type=primary --file-prefix=simple_mp
EAL: Detected CPU lcores: 4
EAL: Detected NUMA nodes: 1
...
Starting core 1

simple_mp &gt;
</code></pre><pre tabindex=0><code>root@hugepage-2c-2p-2:~/dpdk# ./dpdk-simple_mp -l 2-3 -n 1 --proc-type=secondary --file-prefix=simple_mp
EAL: Detected CPU lcores: 4
EAL: Detected NUMA nodes: 1
EAL: Detected static linkage of DPDK
EAL: Multi-process socket /var/run/dpdk/simple_mp/mp_socket_45_6d552daffb0f
EAL: Selected IOVA mode &#39;VA&#39;
EAL: Probe PCI driver: net_virtio (1af4:1000) device: 0000:00:03.0 (socket 0)
Device 0000:00:03.0 is not driven by the primary process
EAL: Requested device 0000:00:03.0 cannot be used
APP: Finished Process Init.

simple_mp &gt;
</code></pre><pre tabindex=0><code>$ ls -al /dev/hugepages/
total 8192
drwxr-xr-x  2 root root       0 Mar 14 14:51 .
drwxr-xr-x 19 root root    3820 Mar 14 09:29 ..
-rw-------  1 root root 2097152 Mar 14 14:50 rtemap_0
-rw-------  1 root root 2097152 Mar 14 14:50 rtemap_1
-rw-------  1 root root 2097152 Mar 14 14:52 simple_mpmap_0
-rw-------  1 root root 2097152 Mar 14 14:52 simple_mpmap_1
</code></pre><pre tabindex=0><code>$ grep HugePages_ /proc/meminfo
HugePages_Total:      20
HugePages_Free:       16
HugePages_Rsvd:        0
HugePages_Surp:        0
</code></pre><p>단, pod가 모두 삭제되어도 위 hugepage map file이 삭제되지 않으므로, 사용된 hugepage는 해제되지 않는다(해제되는 조건은???)</p><pre tabindex=0><code>$ sudo rm -rf /dev/hugepages/*
[sudo] password for cychong:

$ grep HugePages_ /proc/meminfo
HugePages_Total:      20
HugePages_Free:       20
HugePages_Rsvd:        0
HugePages_Surp:        0
</code></pre><h2 id=simplified-view>Simplified view</h2><p><img src=/images/2022/03/2022-03-14-dpdk-hugepage-1c-2p-2.png alt=2022-03-14-dpdk-hugepage-1c-2p-2.png></p><h2 id=reference>Reference</h2><p><a href=https://github.com/cychong47/how-to-share-hugepage-in-k8s/tree/main/one-container-in-each-pod>https://github.com/cychong47/how-to-share-hugepage-in-k8s/tree/main/one-container-in-each-pod</a></p><p>#til #dpdk #hugepage</p></content><p><a href=https://cychong47.github.io/tags/kubernetes/>#Kubernetes</a>
<a href=https://cychong47.github.io/tags/dpdk/>#DPDK</a>
<a href=https://cychong47.github.io/tags/hugepage/>#Hugepage</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>