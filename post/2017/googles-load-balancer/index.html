<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Google's Load Balancer | Keep calm and Write something</title><meta name=title content="Google's Load Balancer"><meta name=description content="Maglev

Google( https://research.google.com/pubs/pub44824.html )
Used in Google Cloud since 2008
Scalable load balancer

Consistent hashing
Connection Tracking
Scale-out model backed by router&rsquo;s ECMP


Bypass kernel space for performance.
Support connection persistence

Network Architecture

DNS - Routers - Maglevs - Service EndPoints.
One service is served by one or more VIPs

DNS returns VIP considering geolocation and load of location


One VIP is served by multiple Maglevs

Router use ECMP to select one Maglev


One VIP is mapped to multiple Service EndPoints

Maglev select Service EndPoint by seletion algorithm and connection tracking table


Maglev use GRE to send incoming packet to Service EndPoint or another Maglev

Send to IP fragment to another special Maglev servers
Use only 3-tuple for IP fragment


Each Service EndPoint use Direct Server Return(DSR)

Maglev
Controller

Responsible for VIP announcement with BGP
Check health status of forwarder
If forwarder is not headthy, withdraw all VIP announcements

Forwarder

Each VIP has one or multiple backend pools(BP)
BP contain physical IP address of the Service EndPoint
Each BP has specific health checking methods - depends on the service requirement(just reachability or more)
Config Manager parse and update configuration of forwarder&rsquo;s behavior based on the Config Objects
Sharding

Sharding of Maglev enables service isolation - new service or QoS



Backend Selection

Consistent Hashing distribute loads
Record selection in LOCAL connection tracking table

Connection tracking table is not shared with another Maglev
Does not guarantee consistency on Maglev or Service EndPoint Changes(add/delete)


For different traffic type

TCP SYN : select Backend and record it in connection tracking table
TCP non-SYN : lookup connection tracking table
5-tuple : (maybe) lookup connection tracking table and select backend if not found



Consistent Hashing

If Maglev is added or removed, router select different Maglev for the exsiting session - ECMP is changed
If one Maglev&rsquo;s local connection tracking table is overflowed, it will lose previous selection
To resolve this issues,

Synchronize local connection tracking table between Maglevs -> overhead, overhead, overhead
Consistent hashing for minimize disruption in member changes
Maglev hashing - load balancing and minimal disruption on member changes



reference

Maglev: A Fast and Reliable Software Network Load Balancer
Consistent Hashing
The Simple Magic of Consistent Hashing
"><meta name=keywords content="google,maglev,load balancer,lb,http,tcp,"><meta property="og:url" content="https://cychong47.github.io/post/2017/googles-load-balancer/"><meta property="og:site_name" content="Keep calm and Write something"><meta property="og:title" content="Google's Load Balancer"><meta property="og:description" content="Maglev Google( https://research.google.com/pubs/pub44824.html ) Used in Google Cloud since 2008 Scalable load balancer Consistent hashing Connection Tracking Scale-out model backed by router’s ECMP Bypass kernel space for performance. Support connection persistence Network Architecture DNS - Routers - Maglevs - Service EndPoints. One service is served by one or more VIPs DNS returns VIP considering geolocation and load of location One VIP is served by multiple Maglevs Router use ECMP to select one Maglev One VIP is mapped to multiple Service EndPoints Maglev select Service EndPoint by seletion algorithm and connection tracking table Maglev use GRE to send incoming packet to Service EndPoint or another Maglev Send to IP fragment to another special Maglev servers Use only 3-tuple for IP fragment Each Service EndPoint use Direct Server Return(DSR) Maglev Controller Responsible for VIP announcement with BGP Check health status of forwarder If forwarder is not headthy, withdraw all VIP announcements Forwarder Each VIP has one or multiple backend pools(BP) BP contain physical IP address of the Service EndPoint Each BP has specific health checking methods - depends on the service requirement(just reachability or more) Config Manager parse and update configuration of forwarder’s behavior based on the Config Objects Sharding Sharding of Maglev enables service isolation - new service or QoS Backend Selection Consistent Hashing distribute loads Record selection in LOCAL connection tracking table Connection tracking table is not shared with another Maglev Does not guarantee consistency on Maglev or Service EndPoint Changes(add/delete) For different traffic type TCP SYN : select Backend and record it in connection tracking table TCP non-SYN : lookup connection tracking table 5-tuple : (maybe) lookup connection tracking table and select backend if not found Consistent Hashing If Maglev is added or removed, router select different Maglev for the exsiting session - ECMP is changed If one Maglev’s local connection tracking table is overflowed, it will lose previous selection To resolve this issues, Synchronize local connection tracking table between Maglevs -> overhead, overhead, overhead Consistent hashing for minimize disruption in member changes Maglev hashing - load balancing and minimal disruption on member changes reference Maglev: A Fast and Reliable Software Network Load Balancer Consistent Hashing The Simple Magic of Consistent Hashing"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2017-10-01T08:34:30+09:00"><meta property="article:modified_time" content="2018-04-01T02:38:51+00:00"><meta property="article:tag" content="Google"><meta property="article:tag" content="Maglev"><meta property="article:tag" content="Load Balancer"><meta property="article:tag" content="Lb"><meta property="article:tag" content="Http"><meta property="article:tag" content="Tcp"><meta name=twitter:card content="summary"><meta name=twitter:title content="Google's Load Balancer"><meta name=twitter:description content="Maglev Google( https://research.google.com/pubs/pub44824.html ) Used in Google Cloud since 2008 Scalable load balancer Consistent hashing Connection Tracking Scale-out model backed by router’s ECMP Bypass kernel space for performance. Support connection persistence Network Architecture DNS - Routers - Maglevs - Service EndPoints. One service is served by one or more VIPs DNS returns VIP considering geolocation and load of location One VIP is served by multiple Maglevs Router use ECMP to select one Maglev One VIP is mapped to multiple Service EndPoints Maglev select Service EndPoint by seletion algorithm and connection tracking table Maglev use GRE to send incoming packet to Service EndPoint or another Maglev Send to IP fragment to another special Maglev servers Use only 3-tuple for IP fragment Each Service EndPoint use Direct Server Return(DSR) Maglev Controller Responsible for VIP announcement with BGP Check health status of forwarder If forwarder is not headthy, withdraw all VIP announcements Forwarder Each VIP has one or multiple backend pools(BP) BP contain physical IP address of the Service EndPoint Each BP has specific health checking methods - depends on the service requirement(just reachability or more) Config Manager parse and update configuration of forwarder’s behavior based on the Config Objects Sharding Sharding of Maglev enables service isolation - new service or QoS Backend Selection Consistent Hashing distribute loads Record selection in LOCAL connection tracking table Connection tracking table is not shared with another Maglev Does not guarantee consistency on Maglev or Service EndPoint Changes(add/delete) For different traffic type TCP SYN : select Backend and record it in connection tracking table TCP non-SYN : lookup connection tracking table 5-tuple : (maybe) lookup connection tracking table and select backend if not found Consistent Hashing If Maglev is added or removed, router select different Maglev for the exsiting session - ECMP is changed If one Maglev’s local connection tracking table is overflowed, it will lose previous selection To resolve this issues, Synchronize local connection tracking table between Maglevs -> overhead, overhead, overhead Consistent hashing for minimize disruption in member changes Maglev hashing - load balancing and minimal disruption on member changes reference Maglev: A Fast and Reliable Software Network Load Balancer Consistent Hashing The Simple Magic of Consistent Hashing"><meta itemprop=name content="Google's Load Balancer"><meta itemprop=description content="Maglev Google( https://research.google.com/pubs/pub44824.html ) Used in Google Cloud since 2008 Scalable load balancer Consistent hashing Connection Tracking Scale-out model backed by router’s ECMP Bypass kernel space for performance. Support connection persistence Network Architecture DNS - Routers - Maglevs - Service EndPoints. One service is served by one or more VIPs DNS returns VIP considering geolocation and load of location One VIP is served by multiple Maglevs Router use ECMP to select one Maglev One VIP is mapped to multiple Service EndPoints Maglev select Service EndPoint by seletion algorithm and connection tracking table Maglev use GRE to send incoming packet to Service EndPoint or another Maglev Send to IP fragment to another special Maglev servers Use only 3-tuple for IP fragment Each Service EndPoint use Direct Server Return(DSR) Maglev Controller Responsible for VIP announcement with BGP Check health status of forwarder If forwarder is not headthy, withdraw all VIP announcements Forwarder Each VIP has one or multiple backend pools(BP) BP contain physical IP address of the Service EndPoint Each BP has specific health checking methods - depends on the service requirement(just reachability or more) Config Manager parse and update configuration of forwarder’s behavior based on the Config Objects Sharding Sharding of Maglev enables service isolation - new service or QoS Backend Selection Consistent Hashing distribute loads Record selection in LOCAL connection tracking table Connection tracking table is not shared with another Maglev Does not guarantee consistency on Maglev or Service EndPoint Changes(add/delete) For different traffic type TCP SYN : select Backend and record it in connection tracking table TCP non-SYN : lookup connection tracking table 5-tuple : (maybe) lookup connection tracking table and select backend if not found Consistent Hashing If Maglev is added or removed, router select different Maglev for the exsiting session - ECMP is changed If one Maglev’s local connection tracking table is overflowed, it will lose previous selection To resolve this issues, Synchronize local connection tracking table between Maglevs -> overhead, overhead, overhead Consistent hashing for minimize disruption in member changes Maglev hashing - load balancing and minimal disruption on member changes reference Maglev: A Fast and Reliable Software Network Load Balancer Consistent Hashing The Simple Magic of Consistent Hashing"><meta itemprop=datePublished content="2017-10-01T08:34:30+09:00"><meta itemprop=dateModified content="2018-04-01T02:38:51+00:00"><meta itemprop=wordCount content="363"><meta itemprop=keywords content="Google,Maglev,Load Balancer,Lb,Http,Tcp"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>Keep calm and Write something</h2></a><nav><a href=/post/>Post</a>
<a href=/page/>Page</a>
<a href=/series/>Series</a>
<a href=/tags/>Tag</a>
<a href=/archive/>Archive</a>
<a href=/search/>Search</a></nav></header><main><content><h1 id=maglev>Maglev</h1><ul><li>Google( <a href=https://research.google.com/pubs/pub44824.html>https://research.google.com/pubs/pub44824.html</a> )</li><li>Used in Google Cloud since 2008</li><li>Scalable load balancer<ul><li>Consistent hashing</li><li>Connection Tracking</li><li>Scale-out model backed by router&rsquo;s ECMP</li></ul></li><li>Bypass kernel space for performance.</li><li>Support connection persistence</li></ul><h1 id=network-architecture>Network Architecture</h1><ul><li>DNS - Routers - Maglevs - Service EndPoints.</li><li>One service is served by one or more VIPs<ul><li>DNS returns VIP considering geolocation and load of location</li></ul></li><li>One VIP is served by multiple Maglevs<ul><li>Router use ECMP to select one Maglev</li></ul></li><li>One VIP is mapped to multiple Service EndPoints<ul><li>Maglev select Service EndPoint by seletion algorithm and connection tracking table</li></ul></li><li>Maglev use GRE to send incoming packet to Service EndPoint or another Maglev<ul><li>Send to IP fragment to another special Maglev servers</li><li>Use only 3-tuple for IP fragment</li></ul></li><li>Each Service EndPoint use Direct Server Return(DSR)</li></ul><h1 id=maglev-1>Maglev</h1><h2 id=controller>Controller</h2><ul><li>Responsible for VIP announcement with BGP</li><li>Check health status of forwarder</li><li>If forwarder is not headthy, withdraw all VIP announcements</li></ul><h2 id=forwarder>Forwarder</h2><ul><li>Each VIP has one or multiple backend pools(BP)</li><li>BP contain physical IP address of the Service EndPoint</li><li>Each BP has specific health checking methods - depends on the service requirement(just reachability or more)</li><li>Config Manager parse and update configuration of forwarder&rsquo;s behavior based on the <strong>Config Objects</strong></li><li>Sharding<ul><li>Sharding of Maglev enables service isolation - new service or QoS</li></ul></li></ul><h3 id=backend-selection>Backend Selection</h3><ul><li>Consistent Hashing distribute loads</li><li>Record selection in <strong>LOCAL connection tracking table</strong><ul><li>Connection tracking table is <strong>not shared</strong> with another Maglev</li><li>Does not guarantee consistency on Maglev or Service EndPoint Changes(add/delete)</li></ul></li><li>For different traffic type<ul><li>TCP SYN : select Backend and record it in connection tracking table</li><li>TCP non-SYN : lookup connection tracking table</li><li>5-tuple : (maybe) lookup connection tracking table and select backend if not found</li></ul></li></ul><h1 id=consistent-hashing>Consistent Hashing</h1><ul><li>If Maglev is added or removed, router select different Maglev for the exsiting session - ECMP is changed</li><li>If one Maglev&rsquo;s local connection tracking table is overflowed, it will lose previous selection</li><li>To resolve this issues,<ul><li>Synchronize local connection tracking table between Maglevs -> overhead, overhead, overhead</li><li>Consistent hashing for minimize disruption in member changes</li><li>Maglev hashing - load balancing and minimal disruption on member changes</li></ul></li></ul><h1 id=reference>reference</h1><ul><li><a href=https://blog.acolyer.org/2016/03/21/maglev-a-fast-and-reliable-software-network-load-balancer/>Maglev: A Fast and Reliable Software Network Load Balancer</a></li><li><a href=http://blog.carlosgaldino.com/consistent-hashing.html>Consistent Hashing</a></li><li><a href=https://dzone.com/articles/simple-magic-consistent>The Simple Magic of Consistent Hashing</a></li></ul></content><p><a href=https://cychong47.github.io/tags/google/>#Google</a>
<a href=https://cychong47.github.io/tags/maglev/>#Maglev</a>
<a href=https://cychong47.github.io/tags/load-balancer/>#Load Balancer</a>
<a href=https://cychong47.github.io/tags/lb/>#Lb</a>
<a href=https://cychong47.github.io/tags/http/>#Http</a>
<a href=https://cychong47.github.io/tags/tcp/>#Tcp</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>