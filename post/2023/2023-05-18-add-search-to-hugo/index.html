<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>hugo에 검색 기능 추가하기 - pagefind | Keep calm and Write something</title><meta name=title content="hugo에 검색 기능 추가하기 - pagefind"><meta name=description content="Why not Agollia
algolla 는 site indexing 을 위해 Algollia 서버로 정보를 보내는 듯 함.
대신 hugo에 아주 seamless 하게 연동이 되는데. 좀 아쉽네.
(Privacy 건은 좀 더 확인해 봐야겠다)
Algollia를 잘 결합해서 사용하는 사이트 하나 https://inchan.dev
Search를 클릭하면 입력 창의 크기가 자동으로 커져서 결과가 보여지는 창도 적당해서 보기 좋다.
Install Pagefind
설치는 npx를 이용해서 설치하거나, cargo build하거나. 혹은 github에 올려져 있는 바이너리 다운받아 설치하거나. 이 중에 마지막 방법 선택
https://github.com/CloudCannon/pagefind/releases"><meta name=keywords content="hugo,pagefind,"><meta property="og:url" content="https://cychong47.github.io/post/2023/2023-05-18-add-search-to-hugo/"><meta property="og:site_name" content="Keep calm and Write something"><meta property="og:title" content="hugo에 검색 기능 추가하기 - pagefind"><meta property="og:description" content="Why not Agollia algolla 는 site indexing 을 위해 Algollia 서버로 정보를 보내는 듯 함. 대신 hugo에 아주 seamless 하게 연동이 되는데. 좀 아쉽네. (Privacy 건은 좀 더 확인해 봐야겠다)
Algollia를 잘 결합해서 사용하는 사이트 하나 https://inchan.dev Search를 클릭하면 입력 창의 크기가 자동으로 커져서 결과가 보여지는 창도 적당해서 보기 좋다.
Install Pagefind 설치는 npx를 이용해서 설치하거나, cargo build하거나. 혹은 github에 올려져 있는 바이너리 다운받아 설치하거나. 이 중에 마지막 방법 선택
https://github.com/CloudCannon/pagefind/releases"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-05-18T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-18T00:00:00+00:00"><meta property="article:tag" content="Hugo"><meta property="article:tag" content="Pagefind"><meta property="og:see_also" content="https://cychong47.github.io/post/2020/2020-09-12-image-is-not-jpg-but-heic/"><meta property="og:see_also" content="https://cychong47.github.io/post/2020/2020-07-02-deploy-nginx-with-helm/"><meta property="og:see_also" content="https://cychong47.github.io/post/2020/2020-06-27-how-to-support-video/"><meta property="og:see_also" content="https://cychong47.github.io/post/2020/2020-06-13-add-menu-to-hugo/"><meta property="og:see_also" content="https://cychong47.github.io/post/2020/2020-06-07-migrate-ghost-to-hugo/"><meta property="og:see_also" content="https://cychong47.github.io/post/2020/hugo-seutp-with-git/"><meta name=twitter:card content="summary"><meta name=twitter:title content="hugo에 검색 기능 추가하기 - pagefind"><meta name=twitter:description content="Why not Agollia algolla 는 site indexing 을 위해 Algollia 서버로 정보를 보내는 듯 함. 대신 hugo에 아주 seamless 하게 연동이 되는데. 좀 아쉽네. (Privacy 건은 좀 더 확인해 봐야겠다)
Algollia를 잘 결합해서 사용하는 사이트 하나 https://inchan.dev Search를 클릭하면 입력 창의 크기가 자동으로 커져서 결과가 보여지는 창도 적당해서 보기 좋다.
Install Pagefind 설치는 npx를 이용해서 설치하거나, cargo build하거나. 혹은 github에 올려져 있는 바이너리 다운받아 설치하거나. 이 중에 마지막 방법 선택
https://github.com/CloudCannon/pagefind/releases"><meta itemprop=name content="hugo에 검색 기능 추가하기 - pagefind"><meta itemprop=description content="Why not Agollia algolla 는 site indexing 을 위해 Algollia 서버로 정보를 보내는 듯 함. 대신 hugo에 아주 seamless 하게 연동이 되는데. 좀 아쉽네. (Privacy 건은 좀 더 확인해 봐야겠다)
Algollia를 잘 결합해서 사용하는 사이트 하나 https://inchan.dev Search를 클릭하면 입력 창의 크기가 자동으로 커져서 결과가 보여지는 창도 적당해서 보기 좋다.
Install Pagefind 설치는 npx를 이용해서 설치하거나, cargo build하거나. 혹은 github에 올려져 있는 바이너리 다운받아 설치하거나. 이 중에 마지막 방법 선택
https://github.com/CloudCannon/pagefind/releases"><meta itemprop=datePublished content="2023-05-18T00:00:00+00:00"><meta itemprop=dateModified content="2023-05-18T00:00:00+00:00"><meta itemprop=wordCount content="619"><meta itemprop=keywords content="Hugo,Pagefind"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>Keep calm and Write something</h2></a><nav><a href=/post/>Post</a>
<a href=/page/>Page</a>
<a href=/series/>Series</a>
<a href=/tags/>Tag</a>
<a href=/archive/>Archive</a>
<a href=/search/>Search</a></nav></header><main><content><h2 id=why-not-agollia>Why not Agollia</h2><p><code>algolla</code> 는 site indexing 을 위해 Algollia 서버로 정보를 보내는 듯 함.
대신 hugo에 아주 seamless 하게 연동이 되는데. 좀 아쉽네.
(Privacy 건은 좀 더 확인해 봐야겠다)</p><p>Algollia를 잘 결합해서 사용하는 사이트 하나 <a href=https://inchan.dev>https://inchan.dev</a>
Search를 클릭하면 입력 창의 크기가 자동으로 커져서 결과가 보여지는 창도 적당해서 보기 좋다.</p><h2 id=install-pagefind>Install Pagefind</h2><p>설치는 <code>npx</code>를 이용해서 설치하거나, cargo build하거나. 혹은 github에 올려져 있는 바이너리 다운받아 설치하거나. 이 중에 마지막 방법 선택</p><p><a href=https://github.com/CloudCannon/pagefind/releases>https://github.com/CloudCannon/pagefind/releases</a></p><pre tabindex=0><code>wget https://github.com/CloudCannon/pagefind/releases/download/v0.12.0/pagefind-v0.12.0-x86_64-unknown-linux-musl.tar.gz
</code></pre><p>이것 보다는 multi-byte 처리를 고려한 이 버전을 받는 게 좋을 듯함</p><pre tabindex=0><code>wget https://github.com/CloudCannon/pagefind/releases/download/v0.12.0/pagefind_extended-v0.12.0-x86_64-unknown-linux-musl.tar.gz
</code></pre><h2 id=how-to-run>How to run</h2><pre tabindex=0><code>./pagefind_extended --source &#34;public&#34;
</code></pre><h3 id=configuration-file>Configuration File</h3><ul><li><code>pagefind.toml</code>, <code>pagefind.yml/yaml</code>, <code>pagefind.json</code> 등을 사용할 수 있다고 함.</li><li>다만 아래와 같이 기본 값을 그대로 사용하는 경우에는 별도로 설정 파일을 만들 필요 없음.</li></ul><pre tabindex=0><code>source: public
bundle_dir: _pagefind
</code></pre><p>이 정보들은 환경변수를 이용해 설정할 수도 있음</p><pre tabindex=0><code>PAGEFIND_BUNDLE_DIR=&#34;_pagefind&#34; PAGEFIND_SOURCE=&#34;public&#34; ./pagefind_extended
</code></pre><p>여기서 <code>_bundle_dir</code>은 indexing된 결과를 저장할 output directory를 의미 ( <a href=https://pagefind.app/docs/config-options/>Configuring the Pagefind CLI</a> 참고 )</p><h2 id=build-a-index>Build a index</h2><p>256MB, 1 core를 할당한 <code>LXC</code> 기반의 container에서 <code>github-action</code>을 실행하고 있어, 그 머신에서 <code>pagefind_extended</code>를 이용해서 빌드하라고 시켰는데 오잉. 중간에 pagefind가 kill되었다고 나온다.</p><pre tabindex=0><code>5m 6s

&gt; Run pagefind_extended --source public

Running Pagefind v0.12.0 (Extended)
Running from: &#34;/home/cychong/actions-runner/_work/blog/blog&#34;
Source: &#34;public&#34;
Bundle Directory: &#34;_pagefind&#34;

[Walking source directory]
Found 5204 files matching **/*.{html}

[Parsing files]
/home/cychong/actions-runner/_work/_temp/09bfda6f-b57f-454f-90b5-27d8e95e6908.sh: line 1: 20632 Killed pagefind_extended --source public
Error: Process completed with exit code 137.
</code></pre><p><code>OOM(Out Of Memory)</code> 로 process 가 종료되는 경우를 종종 봐서(고작 16GB를 가진 mini3에서 kubernetes를 실행하다 보니 종종 pod가 OOM으로 종료되는 것을 봐서) 혹시나 하고 action-runner LXC의 메모리를 256MB에서 1024MB로 늘린 후 돌려보니 정상적으로 돌아간다.</p><p>실제 동작 중 system monitor를 보니 1GB를 모두 사용하는 경우가 있는데, 대부분 <code>pagefind</code>가 동작하는 시간이 아닐까 싶다.</p><p><img src=/images/2023/05/2023-05-18-pagefind-memory-usage.png alt></p><p>실행 결과는 이렇게 나오는데 마지막에 있는 것 같이 indexing에 37초 가량이 걸린다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pagefind_extended --source public --verbose
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Running Pagefind v0.12.0 <span style=color:#f92672>(</span>Extended<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Running in verbose mode
</span></span><span style=display:flex><span>Running from: <span style=color:#e6db74>&#34;/home/cychong/actions-runner/_work/blog/blog&#34;</span>
</span></span><span style=display:flex><span>Source:       <span style=color:#e6db74>&#34;public&#34;</span>
</span></span><span style=display:flex><span>Bundle Directory:  <span style=color:#e6db74>&#34;_pagefind&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Walking source directory<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Found <span style=color:#ae81ff>5204</span> files matching **/*.<span style=color:#f92672>{</span>html<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Parsing files<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Did not find a data-pagefind-body element on the site.
</span></span><span style=display:flex><span>↳ Indexing all &lt;body&gt; elements on the site.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Reading languages<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Discovered <span style=color:#ae81ff>1</span> language: en
</span></span><span style=display:flex><span>  * en: <span style=color:#ae81ff>4613</span> pages
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Building search indexes<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Language en:
</span></span><span style=display:flex><span>  Indexed <span style=color:#ae81ff>4613</span> pages
</span></span><span style=display:flex><span>  Indexed <span style=color:#ae81ff>82547</span> words
</span></span><span style=display:flex><span>  Indexed <span style=color:#ae81ff>0</span> filters
</span></span><span style=display:flex><span>  Indexed <span style=color:#ae81ff>0</span> sorts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total:
</span></span><span style=display:flex><span>  Indexed <span style=color:#ae81ff>1</span> language
</span></span><span style=display:flex><span>  Indexed <span style=color:#ae81ff>4613</span> pages
</span></span><span style=display:flex><span>  Indexed <span style=color:#ae81ff>82547</span> words
</span></span><span style=display:flex><span>  Indexed <span style=color:#ae81ff>0</span> filters
</span></span><span style=display:flex><span>  Indexed <span style=color:#ae81ff>0</span> sorts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Finished in 36.867 seconds
</span></span></code></pre></div><p>이제 빌드는 잘 되니 검색 결과를 이용할 수 있게 html 파일을 수정하면 될 듯.</p><h2 id=blog에-추가>blog에 추가</h2><p>지금 사용하고 있는 <code>mainroad</code> theme는 sidebar widget을 이용해서 search 기능을 제공하고 있다.
<code>config.toml</code> 설정 중 일부</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>  <span style=color:#a6e22e>widgets</span> = [<span style=color:#e6db74>&#34;search&#34;</span>, <span style=color:#e6db74>&#34;categories&#34;</span>, <span style=color:#e6db74>&#34;series&#34;</span>, <span style=color:#e6db74>&#34;taglist&#34;</span>]
</span></span></code></pre></div><p>이 search 기능은 google 기능을 이용하는데 현재 블로그가 internal network에서만 접근할 수 있게 되어 있다 보니 검색이 제대로 동작하지 않는다. 외부에서 접근이 가능해도 검색 기능이 그닥 쓸모있지 않았지만.</p><p>이제 할 것은 <a href=https://pagefind.app/docs/indexing/#limiting-what-content-is-indexed>pagefind documentation</a> 에 있는 search 내용을 처리할 코드를 <code>layouts/partials/widgets/search.html</code>에 만들기. 아래 코드는 pagefind documentation에 있는 내용과 기존에 사용하던 다른 widget의 코드를 합쳐서 기존 mainroad theme과 어울리게 만든 것이다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>link</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/_pagefind/pagefind-ui.css&#34;</span> <span style=color:#a6e22e>rel</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;stylesheet&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/_pagefind/pagefind-ui.js&#34;</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text/javascript&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;widget-categories widget&#34;</span>&gt;
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>h4</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;widget__title&#34;</span>&gt;Search&lt;/<span style=color:#f92672>h4</span>&gt;
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;search&#34;</span>&gt;&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>		window.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#39;DOMContentLoaded&#39;</span>, (<span style=color:#a6e22e>event</span>) =&gt; {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PagefindUI</span>({ <span style=color:#a6e22e>element</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;#search&#34;</span> });
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>	&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>div</span>&gt;
</span></span></code></pre></div><p><img src=/images/2023/05/2023-05-18-search-in-sidebar.png alt></p><p>검색을 하면 이렇게 검색 창 아래에 결과가 나온다.
<img src=/images/2023/05/2023-05-18-pagefind_search_result.png alt></p><h2 id=github-action-에-추가>github action 에 추가</h2><p>자동으로 hugo로 빌드할 때마다 자동으로 indexing을 할 수 있게 github의 action flow 수정한다.
아래의 경우는 local github action runner를에서 미리 설치해 높은 <code>pagefind_extended</code>를 사용하는 경우이고,
<code>cat .github/workflows/main.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          rm -rf public/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          hugo -t mainroad</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>indexing with pagefind</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          pagefind_extended --source public</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Deploy</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          pwd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          rsync -az public/* cychong@${{ secrets.GH_BLOG_TARGET }}:/home/cychong/public/blog/</span>
</span></span></code></pre></div><p>github.com이 제공하는 runner를 사용하는 경우에는 이렇게 <code>npx pagefind@latest</code>로 명시했다.
<code>pagefind</code> 썰치 문서에 보면 <code>npx pagefind</code>를 실행하면 자동으로 <code>pagefind_extended</code>를 설치한다고</p><blockquote><p>Running Pagefind via npx will download the <code>pagefind_extended</code> release, which includes specialized support for indexing Chinese and Japanese pages.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run Pagefind</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm_config_yes=true npx pagefind@latest --source &#34;public&#34;</span>
</span></span></code></pre></div><h2 id=reference>Reference</h2><ul><li><a href=https://www.brycewray.com/posts/2022/07/pagefind-quite-find-site-search/>https://www.brycewray.com/posts/2022/07/pagefind-quite-find-site-search/</a></li><li><a href=https://www.brycewray.com/posts/2022/07/impressions-hugoconf-2022/>https://www.brycewray.com/posts/2022/07/impressions-hugoconf-2022/</a></li><li><a href=https://patford12.medium.com/add-search-to-hugo-with-page-find-4e78c9b37541>https://patford12.medium.com/add-search-to-hugo-with-page-find-4e78c9b37541</a></li><li><a href=https://pagefind.app/docs/installation/>https://pagefind.app/docs/installation/</a></li></ul></content><p><a href=https://cychong47.github.io/tags/hugo/>#Hugo</a>
<a href=https://cychong47.github.io/tags/pagefind/>#Pagefind</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>