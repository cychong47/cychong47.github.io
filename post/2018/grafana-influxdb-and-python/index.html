<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Grafana, influxDB and python | Keep calm and Write something</title><meta name=title content="Grafana, influxDB and python"><meta name=description content="Time-series data를 python을 이용해서 influxDB에 저장하고, Grafana로 그래프를 보여주는 예제
https://github.com/cychong47/influxdb_example.git
Install Grafana and influxDB
Install Grafana
직접 호스트에 설치할 수도 있지만, 세상 편하게 만들어준 docker를 이용해서 grafana, influxdb등을 설치하자.
mbpr15:~ cychong$ docker pull grafana/grafana 
Using default tag: latest
latest: Pulling from grafana/grafana
f2aa67a397c4: Pull complete 
89573effc7c8: Pull complete 
b55c103da375: Pull complete 
Digest: sha256:364bec4a39ecbec744ea4270aae35f6554eb6f2047b3ee08f7b5f1134857c32c
Status: Downloaded newer image for grafana/grafana:latest
Start grafana
mbpr15:~ cychong$ docker run -d -p 3000:3000 —name grafana grafana/grafana 
148894d7009259b02b04e1a98467f549400be91f9b055f8686557d69b9339e4b
Install influxDB
influxdb도 docker 명령어 하나로 설치"><meta name=keywords content="Python,docker,elk,til,monitoring,grafana,influxdb,"><meta property="og:url" content="https://cychong47.github.io/post/2018/grafana-influxdb-and-python/"><meta property="og:site_name" content="Keep calm and Write something"><meta property="og:title" content="Grafana, influxDB and python"><meta property="og:description" content="Time-series data를 python을 이용해서 influxDB에 저장하고, Grafana로 그래프를 보여주는 예제
https://github.com/cychong47/influxdb_example.git
Install Grafana and influxDB Install Grafana 직접 호스트에 설치할 수도 있지만, 세상 편하게 만들어준 docker를 이용해서 grafana, influxdb등을 설치하자.
mbpr15:~ cychong$ docker pull grafana/grafana Using default tag: latest latest: Pulling from grafana/grafana f2aa67a397c4: Pull complete 89573effc7c8: Pull complete b55c103da375: Pull complete Digest: sha256:364bec4a39ecbec744ea4270aae35f6554eb6f2047b3ee08f7b5f1134857c32c Status: Downloaded newer image for grafana/grafana:latest Start grafana
mbpr15:~ cychong$ docker run -d -p 3000:3000 —name grafana grafana/grafana 148894d7009259b02b04e1a98467f549400be91f9b055f8686557d69b9339e4b Install influxDB influxdb도 docker 명령어 하나로 설치"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-06-06T04:33:06+09:00"><meta property="article:modified_time" content="2018-09-09T02:04:46+00:00"><meta property="article:tag" content="Python"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Elk"><meta property="article:tag" content="Til"><meta property="article:tag" content="Monitoring"><meta property="article:tag" content="Grafana"><meta name=twitter:card content="summary"><meta name=twitter:title content="Grafana, influxDB and python"><meta name=twitter:description content="Time-series data를 python을 이용해서 influxDB에 저장하고, Grafana로 그래프를 보여주는 예제
https://github.com/cychong47/influxdb_example.git
Install Grafana and influxDB Install Grafana 직접 호스트에 설치할 수도 있지만, 세상 편하게 만들어준 docker를 이용해서 grafana, influxdb등을 설치하자.
mbpr15:~ cychong$ docker pull grafana/grafana Using default tag: latest latest: Pulling from grafana/grafana f2aa67a397c4: Pull complete 89573effc7c8: Pull complete b55c103da375: Pull complete Digest: sha256:364bec4a39ecbec744ea4270aae35f6554eb6f2047b3ee08f7b5f1134857c32c Status: Downloaded newer image for grafana/grafana:latest Start grafana
mbpr15:~ cychong$ docker run -d -p 3000:3000 —name grafana grafana/grafana 148894d7009259b02b04e1a98467f549400be91f9b055f8686557d69b9339e4b Install influxDB influxdb도 docker 명령어 하나로 설치"><meta itemprop=name content="Grafana, influxDB and python"><meta itemprop=description content="Time-series data를 python을 이용해서 influxDB에 저장하고, Grafana로 그래프를 보여주는 예제
https://github.com/cychong47/influxdb_example.git
Install Grafana and influxDB Install Grafana 직접 호스트에 설치할 수도 있지만, 세상 편하게 만들어준 docker를 이용해서 grafana, influxdb등을 설치하자.
mbpr15:~ cychong$ docker pull grafana/grafana Using default tag: latest latest: Pulling from grafana/grafana f2aa67a397c4: Pull complete 89573effc7c8: Pull complete b55c103da375: Pull complete Digest: sha256:364bec4a39ecbec744ea4270aae35f6554eb6f2047b3ee08f7b5f1134857c32c Status: Downloaded newer image for grafana/grafana:latest Start grafana
mbpr15:~ cychong$ docker run -d -p 3000:3000 —name grafana grafana/grafana 148894d7009259b02b04e1a98467f549400be91f9b055f8686557d69b9339e4b Install influxDB influxdb도 docker 명령어 하나로 설치"><meta itemprop=datePublished content="2018-06-06T04:33:06+09:00"><meta itemprop=dateModified content="2018-09-09T02:04:46+00:00"><meta itemprop=wordCount content="1151"><meta itemprop=keywords content="Python,Docker,Elk,Til,Monitoring,Grafana,Influxdb"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>Keep calm and Write something</h2></a><nav><a href=/post/>Post</a>
<a href=/page/>Page</a>
<a href=/series/>Series</a>
<a href=/tags/>Tag</a>
<a href=/archive/>Archive</a>
<a href=/search/>Search</a></nav></header><main><content><p>Time-series data를 python을 이용해서 influxDB에 저장하고, Grafana로 그래프를 보여주는 예제</p><p><a href=https://github.com/cychong47/influxdb_example.git>https://github.com/cychong47/influxdb_example.git</a></p><h1 id=install-grafana-and-influxdb>Install Grafana and influxDB</h1><h2 id=install-grafana>Install Grafana</h2><p>직접 호스트에 설치할 수도 있지만, 세상 편하게 만들어준 docker를 이용해서 grafana, influxdb등을 설치하자.</p><pre tabindex=0><code>mbpr15:~ cychong$ docker pull grafana/grafana 
Using default tag: latest
latest: Pulling from grafana/grafana
f2aa67a397c4: Pull complete 
89573effc7c8: Pull complete 
b55c103da375: Pull complete 
Digest: sha256:364bec4a39ecbec744ea4270aae35f6554eb6f2047b3ee08f7b5f1134857c32c
Status: Downloaded newer image for grafana/grafana:latest
</code></pre><p>Start <code>grafana</code></p><pre tabindex=0><code>mbpr15:~ cychong$ docker run -d -p 3000:3000 —name grafana grafana/grafana 
148894d7009259b02b04e1a98467f549400be91f9b055f8686557d69b9339e4b
</code></pre><h2 id=install-influxdb>Install influxDB</h2><p>influxdb도 docker 명령어 하나로 설치</p><p><a href=https://docs.docker.com/samples/library/influxdb/>influxdb | Docker Documentation</a></p><pre tabindex=0><code>mbpr15:~ cychong$ docker pull influxdb
Using default tag: latest
latest: Pulling from library/influxdb
cc1a78bfd46b: Pull complete 
6861473222a6: Pull complete 
7e0b9c3b5ae0: Pull complete 
ef1cd6af9147: Pull complete 
07d71592a7b6: Pull complete 
4df1ab172fbc: Pull complete 
6f607c73c187: Pull complete 
3fd297f39292: Pull complete 
Digest: sha256:e3efb51395d630a912c3c24edb7567ec1ac01d3dfdc39f27f53ca0e15c3da797
Status: Downloaded newer image for influxdb:latest
</code></pre><h2 id=install-influxdb-module-for-python>Install influxdb module for python</h2><p>python에서 직접 influxDB를 사용하려면 <code>influxdb</code> 모듈을 사용한다</p><pre tabindex=0><code>mbpr15:~ cychong$ pip3 install influxdb
Collecting influxdb
  Downloading https://files.pythonhosted.org/packages/8d/79/7972c12e393080eda6920583c9c2ed2206771da7f6341c8971a2c02ff3d3/influxdb-5.0.0-py2.py3-none-any.whl (70kB)
    100% |████████████████████████████████| 71kB 709kB/s 
Requirement already satisfied: requests&gt;=2.17.0 in /usr/local/lib/python3.6/site-packages (from influxdb) (2.18.4)
Collecting python-dateutil&gt;=2.6.0 (from influxdb)
  Downloading https://files.pythonhosted.org/packages/cf/f5/af2b09c957ace60dcfac112b669c45c8c97e32f94aa8b56da4c6d1682825/python_dateutil-2.7.3-py2.py3-none-any.whl (211kB)
    100% |████████████████████████████████| 215kB 2.9MB/s 
Collecting pytz (from influxdb)
  Downloading https://files.pythonhosted.org/packages/dc/83/15f7833b70d3e067ca91467ca245bae0f6fe56ddc7451aa0dc5606b120f2/pytz-2018.4-py2.py3-none-any.whl (510kB)
    100% |████████████████████████████████| 512kB 5.0MB/s 
Requirement already satisfied: six&gt;=1.10.0 in /usr/local/lib/python3.6/site-packages (from influxdb) (1.11.0)
Requirement already satisfied: certifi&gt;=2017.4.17 in /usr/local/lib/python3.6/site-packages (from requests&gt;=2.17.0-&gt;influxdb) (2017.11.5)
Requirement already satisfied: idna&lt;2.7,&gt;=2.5 in /usr/local/lib/python3.6/site-packages (from requests&gt;=2.17.0-&gt;influxdb) (2.6)
Requirement already satisfied: chardet&lt;3.1.0,&gt;=3.0.2 in /usr/local/lib/python3.6/site-packages (from requests&gt;=2.17.0-&gt;influxdb) (3.0.4)
Requirement already satisfied: urllib3&lt;1.23,&gt;=1.21.1 in /usr/local/lib/python3.6/site-packages (from requests&gt;=2.17.0-&gt;influxdb) (1.22)
hacking 1.0.0 has requirement flake8&lt;2.6.0,&gt;=2.5.4, but you’ll have flake8 3.5.0 which is incompatible.
hacking 1.0.0 has requirement mccabe==0.2.1, but you’ll have mccabe 0.6.1 which is incompatible.
hacking 1.0.0 has requirement pyflakes==0.8.1, but you’ll have pyflakes 1.6.0 which is incompatible.
docker-compose 1.17.1 has requirement requests!=2.11.0,&lt;2.12,&gt;=2.6.1, but you’ll have requests 2.18.4 which is incompatible.
Installing collected packages: python-dateutil, pytz, influxdb
Successfully installed influxdb-5.0.0 python-dateutil-2.7.3 pytz-2018.4
</code></pre><h2 id=start-influxdb>Start influxdb</h2><p><a href=https://www.influxdata.com/blog/getting-started-python-influxdb/>Getting Started with Python and Influxdb | InfluxData</a></p><pre tabindex=0><code>mbpr15:working cychong$ mkdir influxdb
mbpr15:working cychong$ cd influxdb/
mbpr15:influxdb cychong$ ls
mbpr15:influxdb cychong$ docker run -d -p 8086:8086 -v $PWD:/var/lib/influxdb influxdb
5088889ce21c9c9e2249db701694aa0bd39429371b5dababcf6ebb8c2e7598d3
</code></pre><p>To have customized config file for influxdb.
First generate the default configuration file and update it. Then restart influxdb with that config file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mbpr15:influxdb cychong$ docker run —rm influxdb influxd config &gt; influxdb.conf
</span></span><span style=display:flex><span>Merging with configuration at: /etc/influxdb/influxdb.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mbpr15:influxdb cychong$ docker run -d -p 8086:8086 -v $PWD:/var/lib/influxdb -v $PWD/influxdb.conf:/etc/influxdb/influxdb.conf influxdb -config /etc/influxdb/influxdb.conf
</span></span><span style=display:flex><span>1d9ac4ffdca38b2c627da134273d7570c9c74182cb4bbedb8deebf09c3e5dc0a
</span></span></code></pre></div><h3 id=influx-db-write-error>Influx db write error</h3><p><a href=https://github.com/influxdata/influxdb-python/blob/master/examples/tutorial.py>influxdb-python/tutorial.py at master · influxdata/influxdb-python · GitHub</a> 샘플코드를 그대로 실행시키면 다음과 같은 에러를 만난다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mbpr15:influxdb cychong$ python3 influxdb-ex.py 
</span></span><span style=display:flex><span>Create database: example
</span></span><span style=display:flex><span>Create a retention policy
</span></span><span style=display:flex><span>Switch user: smly
</span></span><span style=display:flex><span>Write points: <span style=color:#f92672>[{</span><span style=color:#e6db74>&#39;measurement&#39;</span>: <span style=color:#e6db74>&#39;cpu_load_short&#39;</span>, <span style=color:#e6db74>&#39;tags&#39;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;host&#39;</span>: <span style=color:#e6db74>&#39;server01&#39;</span>, <span style=color:#e6db74>&#39;region&#39;</span>: <span style=color:#e6db74>&#39;us-west&#39;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#39;time&#39;</span>: <span style=color:#e6db74>&#39;2009-11-10T23:00:00Z&#39;</span>, <span style=color:#e6db74>&#39;fields&#39;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#39;Float_value&#39;</span>: 0.64, <span style=color:#e6db74>&#39;Int_value&#39;</span>: 3, <span style=color:#e6db74>&#39;String_value&#39;</span>: <span style=color:#e6db74>&#39;Text&#39;</span>, <span style=color:#e6db74>&#39;Bool_value&#39;</span>: True<span style=color:#f92672>}}]</span>
</span></span><span style=display:flex><span>Traceback <span style=color:#f92672>(</span>most recent call last<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;influxdb-ex.py&#34;</span>, line 73, in &lt;module&gt;
</span></span><span style=display:flex><span>    main<span style=color:#f92672>(</span>host<span style=color:#f92672>=</span>args.host, port<span style=color:#f92672>=</span>args.port<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;influxdb-ex.py&#34;</span>, line 45, in main
</span></span><span style=display:flex><span>    client.write_points<span style=color:#f92672>(</span>json_body<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;/usr/local/lib/python3.6/site-packages/influxdb/client.py&#34;</span>, line 468, in write_points
</span></span><span style=display:flex><span>    tags<span style=color:#f92672>=</span>tags, protocol<span style=color:#f92672>=</span>protocol<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;/usr/local/lib/python3.6/site-packages/influxdb/client.py&#34;</span>, line 532, in _write_points
</span></span><span style=display:flex><span>    protocol<span style=color:#f92672>=</span>protocol
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;/usr/local/lib/python3.6/site-packages/influxdb/client.py&#34;</span>, line 312, in write
</span></span><span style=display:flex><span>    headers<span style=color:#f92672>=</span>headers
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;/usr/local/lib/python3.6/site-packages/influxdb/client.py&#34;</span>, line 271, in request
</span></span><span style=display:flex><span>    raise InfluxDBClientError<span style=color:#f92672>(</span>response.content, response.status_code<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>influxdb.exceptions.InfluxDBClientError: 400: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;error&#34;</span>:<span style=color:#e6db74>&#34;partial write: points beyond retention policy dropped=1&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>무슨 말인가 찾아보니 <code>retention policy</code>라는 건 db에 저장하는 데이터가 특정 기준이상으로 오래된 것이면 저장을 불허하기 때문에 이 <code>policy</code>에 걸려 write 동작이 실패했다는 것이다.
<a href=https://github.com/influxdata/influxdb/issues/9093>points beyond retention policy !! what does this mean?? · Issue #9093 · influxdata/influxdb · GitHub</a></p><p>참고로 예제에서는 retention policy를 3일로 지정하고 있는데 샘플용 json 데이터에 지정된 시각이 <code>2009-11-10T23:00:00Z</code>라 에러가 발생한 것.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Create a retention policy&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    client<span style=color:#f92672>.</span>create_retention_policy(<span style=color:#e6db74>&#39;awesome_policy&#39;</span>, <span style=color:#e6db74>&#39;3d&#39;</span>, <span style=color:#ae81ff>3</span>, default<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span></code></pre></div><p>샘플에서 time 필드를 현재 시간으로 변경한다. 이때 influxdb가 원하는 시간 형태로 표시해야 한다. <a href=https://stackoverflow.com/questions/32090883/how-to-use-time-field-in-adding-metrics-data-to-the-influx-db>python - How to use time field in adding metrics data to the influx db? - Stack Overflow</a>을 참고하여 수정.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span>current_time <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>utcnow()<span style=color:#f92672>.</span>strftime(<span style=color:#960050;background-color:#1e0010>‘</span><span style=color:#f92672>%</span>Y<span style=color:#f92672>-%</span>m<span style=color:#f92672>-%</span>dT<span style=color:#f92672>%</span>H:<span style=color:#f92672>%</span>M:<span style=color:#f92672>%</span>SZ<span style=color:#960050;background-color:#1e0010>’</span>)
</span></span></code></pre></div><pre tabindex=0><code>    json_body[0][&#39;time&#39;] = datetime.utcnow().strftime(&#39;%Y-%m-%dT%H:%M:%SZ&#39;)
</code></pre><p>수정 후 정상적으로 동작</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mbpr15:influxdb cychong$ python3 influxdb-ex.py 
</span></span><span style=display:flex><span>Create database: example
</span></span><span style=display:flex><span>Create a retention policy
</span></span><span style=display:flex><span>Switch user: smly
</span></span><span style=display:flex><span>Write points: <span style=color:#f92672>[{</span>‘measurement’: ‘cpu_load_short’, ‘tags’: <span style=color:#f92672>{</span>‘host’: ‘server01’, ‘region’: ‘us-west’<span style=color:#f92672>}</span>, ‘time’: ‘2018-06-06T03:08:17Z’, ‘fields’: <span style=color:#f92672>{</span>‘Float_value’: 0.64, ‘Int_value’: 3, ‘String_value’: ‘Text’, ‘Bool_value’: True<span style=color:#f92672>}}]</span>
</span></span><span style=display:flex><span>Querying data: <span style=color:#66d9ef>select</span> value from cpu_load_short;
</span></span><span style=display:flex><span>Result: ResultSet<span style=color:#f92672>({})</span>
</span></span><span style=display:flex><span>Switch user: root
</span></span><span style=display:flex><span>Drop database: example
</span></span></code></pre></div><h2 id=주기적으로-데이터를-influxdb에-저장>주기적으로 데이터를 influxdb에 저장</h2><p>이제 주기적으로 데이터를 db에 저장해서 말그래도 time-series data가 되도록 한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> argparse
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> random
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> influxdb <span style=color:#f92672>import</span> InfluxDBClient
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>setup_db</span>(host, port):
</span></span><span style=display:flex><span>    user <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;root&#39;</span>
</span></span><span style=display:flex><span>    password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;root&#39;</span>
</span></span><span style=display:flex><span>    dbname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;example&#39;</span>
</span></span><span style=display:flex><span>    dbuser <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;smly&#39;</span>
</span></span><span style=display:flex><span>    dbuser_password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;my_secret_password&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    client <span style=color:#f92672>=</span> InfluxDBClient(host, port, user, password, dbname)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Create database: &#34;</span> <span style=color:#f92672>+</span> dbname)
</span></span><span style=display:flex><span>    client<span style=color:#f92672>.</span>create_database(dbname)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Create a retention policy&#34;</span>)
</span></span><span style=display:flex><span>    client<span style=color:#f92672>.</span>create_retention_policy(<span style=color:#e6db74>&#39;awesome_policy&#39;</span>, <span style=color:#e6db74>&#39;3d&#39;</span>, <span style=color:#ae81ff>3</span>, default<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Switch user: &#34;</span> <span style=color:#f92672>+</span> dbuser)
</span></span><span style=display:flex><span>    client<span style=color:#f92672>.</span>switch_user(dbuser, dbuser_password)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_data</span>(client, dl_tp, ul_tp):
</span></span><span style=display:flex><span>    json_body <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;measurement&#34;</span>: <span style=color:#e6db74>&#34;throughput&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;tags&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;host&#34;</span>: <span style=color:#e6db74>&#34;server01&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;region&#34;</span>: <span style=color:#e6db74>&#34;us-west&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;time&#34;</span>: <span style=color:#e6db74>&#34;2009-11-10T23:00:00Z&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;fields&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;dl_tp&#34;</span> : <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;ul_tp&#34;</span> : <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    json_body[<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;time&#39;</span>] <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>utcnow()<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#39;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>T%H:%M:%SZ&#39;</span>)
</span></span><span style=display:flex><span>    json_body[<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;fields&#39;</span>][<span style=color:#e6db74>&#39;dl_tp&#39;</span>] <span style=color:#f92672>=</span> int(dl_tp)
</span></span><span style=display:flex><span>    json_body[<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;fields&#39;</span>][<span style=color:#e6db74>&#39;ul_tp&#39;</span>] <span style=color:#f92672>=</span> int(ul_tp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#print(&#34;Write points: {0}&#34;.format(json_body))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    client<span style=color:#f92672>.</span>write_points(json_body)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;localhost&#39;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>8086</span>):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Instantiate a connection to the InfluxDB.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    client <span style=color:#f92672>=</span> setup_db(host, port)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        dl_tp <span style=color:#f92672>=</span> random<span style=color:#f92672>.</span>uniform(<span style=color:#ae81ff>150</span>,<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>        ul_tp <span style=color:#f92672>=</span> random<span style=color:#f92672>.</span>uniform(<span style=color:#ae81ff>50</span>,<span style=color:#ae81ff>70</span>)
</span></span><span style=display:flex><span>        add_data(client, dl_tp, ul_tp)
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>parse_args</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Parse the args.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    parser <span style=color:#f92672>=</span> argparse<span style=color:#f92672>.</span>ArgumentParser(
</span></span><span style=display:flex><span>        description<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;example code to play with InfluxDB&#39;</span>)
</span></span><span style=display:flex><span>    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--host&#39;</span>, type<span style=color:#f92672>=</span>str, required<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,
</span></span><span style=display:flex><span>                        default<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;localhost&#39;</span>,
</span></span><span style=display:flex><span>                        help<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;hostname of InfluxDB http API&#39;</span>)
</span></span><span style=display:flex><span>    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--port&#39;</span>, type<span style=color:#f92672>=</span>int, required<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, default<span style=color:#f92672>=</span><span style=color:#ae81ff>8086</span>,
</span></span><span style=display:flex><span>                        help<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;port of InfluxDB http API&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> parser<span style=color:#f92672>.</span>parse_args()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    args <span style=color:#f92672>=</span> parse_args()
</span></span><span style=display:flex><span>    main(host<span style=color:#f92672>=</span>args<span style=color:#f92672>.</span>host, port<span style=color:#f92672>=</span>args<span style=color:#f92672>.</span>port)
</span></span></code></pre></div><h2 id=influxdb에서-데이터-확인>Influxdb에서 데이터 확인</h2><p>influxdb container에 접속해서 cli 명령을 통해 db 내용을 확인해 본다.</p><pre tabindex=0><code>mbpr15:influxdb cychong$ docker exec -it 1d9ac4ffdca3 influx
Connected to http://localhost:8086 version 1.5.3
InfluxDB shell version: 1.5.3
&gt; use example
Using database example
&gt; show field keys;
name: throughput
fieldKey fieldType
-------- ---------
dl_tp    integer
ul_tp    integer
&gt; select * from throughput;
name: throughput
time                dl_tp host     region  ul_tp
----                ----- ----     ------  -----
1528255918000000000 0     server01 us-west 0
1528255919000000000 0     server01 us-west 0
1528255920000000000 0     server01 us-west 0
1528255921000000000 0     server01 us-west 0
1528255922000000000 0     server01 us-west 0
...
1528256939000000000 199   server01 us-west 50
1528256940000000000 189   server01 us-west 62
1528256941000000000 163   server01 us-west 50
1528256942000000000 152   server01 us-west 52
1528256943000000000 182   server01 us-west 69
1528256944000000000 191   server01 us-west 55
1528256945000000000 190   server01 us-west 61
1528256946000000000 178   server01 us-west 68
&gt; 
</code></pre><h1 id=grafana에서-influxdb에-저장된-정보-읽어오기>Grafana에서 influxdb에 저장된 정보 읽어오기</h1><p>Grafana에서 data source로 influxdb 지정.(URL 필드에 <code>http://localhost:8086</code> 지정)
이상하게도 같은 머신에서 돌고 있는 influxdb의 주소를 <code>localhost</code>로 지정하면 연결이 안된다는 에러가 난다.</p><p><img src=/images/2018/06/grafana-influxd-localhost-nok.png alt=grafana-influxd-localhost-nok></p><p>머신에 할당된 다른 IP를 지정하면 정상적으로 설정(이때는 스타벅스에서 실행했는데 이때 할당된 IP가 172.20.10.3 이었다)
<img src=/images/2018/06/grafana-influxd-ip-ok.png alt=grafana-influxd-ip-ok></p><h2 id=everything-is-working-finally>Everything is working finally</h2><p><img src=/images/2018/06/grafana-influxd-demo1.png alt=grafana-influxd-demo1></p><h2 id=tips-for-customizing-grafana-dashboard>Tips for customizing grafana dashboard</h2><p>Metric 설정할 때는 <code>FROM</code>에서 influxDB의 <code>measurement</code>를 선택하면 아래 <code>SELECT</code>의 필드에 자동으로 선택할 수 있는 <code>fields</code>가 제시된다.</p><p><img src=/images/2018/06/grafana-influxdb-metric.png alt=grafana-influxdb-metric></p><p>influxDB에 정보를 저장할 때 사용한 json과 비교해 보면 <code>fields</code> 에 정의했던 키들이 제시된다.
<img src=/images/2018/06/grafana-influxdb-metric-fields.png alt=grafana-influxdb-metric-fields></p><p><code>GROUP BY</code> 는 데이터 중 특정 종류에 속하는 것만 보여주고 싶을 때 사용할 수 있다. 예를 들어 <code>fields</code>를 <code>dl_tp</code>와 <code>ul_tp</code>로 정의하지 않고, <code>tags</code>에 <code>direction</code>이라는 필드를 두고, <code>fields</code>는 그냥 <code>tp</code>로 정의할 수 있다. 즉 위 예제는 하나의 데이터 셋에 <code>ul_tp</code>와 <code>dl_tp</code>가 모두 있지만, UL <code>tp</code>만을 가진 데이터 셋과 DL <code>tp</code>만을 가진 데이터 셋으로 분리하여 influxdb에 저장할 수 있다. 이 경우 DL <code>tp</code>만을 가진 데이터 셋만으로 metric을 한정하려면 아래 있는 <code>GROUP BY</code>을 사용하여 <code>tag(diretion)</code>을 선택하면 되지 않을까?
<img src=/images/2018/06/grafana-influxdb-tags-groupby.png alt=grafana-influxdb-tags-groupby></p><p>Axes 의 <code>unit</code>을 데이터에 맞는 적절한 것으로 선택하면 데이터의 특성을 강조할 수 있다. 아래는 <code>data rate</code>의 <code>bits/sec</code>를 선택한 경우이다.(데이터 값이 이미 Mbps로 전달된 경우에는 이를 고려하여 <code>megabits/sec</code>를 선택하면 된다)</p><p><img src=/images/2018/06/grafana-influxdb-change-axes-unit.png alt=grafana-influxdb-change-axes-unit></p></content><p><a href=https://cychong47.github.io/tags/python/>#Python</a>
<a href=https://cychong47.github.io/tags/docker/>#Docker</a>
<a href=https://cychong47.github.io/tags/elk/>#Elk</a>
<a href=https://cychong47.github.io/tags/til/>#Til</a>
<a href=https://cychong47.github.io/tags/monitoring/>#Monitoring</a>
<a href=https://cychong47.github.io/tags/grafana/>#Grafana</a>
<a href=https://cychong47.github.io/tags/influxdb/>#Influxdb</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>