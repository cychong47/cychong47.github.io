<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>2nd patch submit to DPDK | Keep calm and Write something</title><meta name=title content="2nd patch submit to DPDK"><meta name=description content="AVX2가 지원되지 않는 머신에서 쓸데없이 ACL library 빌드할 때 AVX2를 이용해서 빌드하려는 문제를 확인했다. 지금까지 아무도 고치지 않은 게 이상하긴 한데 그래도 내가 생각한 수정 방법이 제대로 동작하는 듯 해서 패치를 한번 보내보기로 했다.
수정사항은 비교적 간단하다.
ACL 라이브러리 빌드할 때 AVX2를 이용해서 빌드해야 하는 경우인지를 검사하는 코드가 lib/librte_acl/Makefile에 정의되어 있는데 여기서 항상 -march=core-avx2 옵션을 사용해서 AVX2가 지원되지 않는 머신에서도 AVX2를 사용해서 gcc가 빌드하도록 하는 걸로 보였다. 다른 코드 빌드할 때는 문제가 없는데 유독 ACL library에서만 이런 문제가 나서 보다 보니 아무래도 Makefile이 잘못된 듯 하다."><meta name=keywords content="DPDK,homebrew,opensource,patch,git,perl,"><meta property="og:url" content="https://cychong47.github.io/post/2018/submit-patch-to-dpdk-with-git/"><meta property="og:site_name" content="Keep calm and Write something"><meta property="og:title" content="2nd patch submit to DPDK"><meta property="og:description" content="AVX2가 지원되지 않는 머신에서 쓸데없이 ACL library 빌드할 때 AVX2를 이용해서 빌드하려는 문제를 확인했다. 지금까지 아무도 고치지 않은 게 이상하긴 한데 그래도 내가 생각한 수정 방법이 제대로 동작하는 듯 해서 패치를 한번 보내보기로 했다.
수정사항은 비교적 간단하다. ACL 라이브러리 빌드할 때 AVX2를 이용해서 빌드해야 하는 경우인지를 검사하는 코드가 lib/librte_acl/Makefile에 정의되어 있는데 여기서 항상 -march=core-avx2 옵션을 사용해서 AVX2가 지원되지 않는 머신에서도 AVX2를 사용해서 gcc가 빌드하도록 하는 걸로 보였다. 다른 코드 빌드할 때는 문제가 없는데 유독 ACL library에서만 이런 문제가 나서 보다 보니 아무래도 Makefile이 잘못된 듯 하다."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-07-21T15:02:14+09:00"><meta property="article:modified_time" content="2018-07-21T15:10:14+00:00"><meta property="article:tag" content="DPDK"><meta property="article:tag" content="Homebrew"><meta property="article:tag" content="Opensource"><meta property="article:tag" content="Patch"><meta property="article:tag" content="Git"><meta property="article:tag" content="Perl"><meta name=twitter:card content="summary"><meta name=twitter:title content="2nd patch submit to DPDK"><meta name=twitter:description content="AVX2가 지원되지 않는 머신에서 쓸데없이 ACL library 빌드할 때 AVX2를 이용해서 빌드하려는 문제를 확인했다. 지금까지 아무도 고치지 않은 게 이상하긴 한데 그래도 내가 생각한 수정 방법이 제대로 동작하는 듯 해서 패치를 한번 보내보기로 했다.
수정사항은 비교적 간단하다. ACL 라이브러리 빌드할 때 AVX2를 이용해서 빌드해야 하는 경우인지를 검사하는 코드가 lib/librte_acl/Makefile에 정의되어 있는데 여기서 항상 -march=core-avx2 옵션을 사용해서 AVX2가 지원되지 않는 머신에서도 AVX2를 사용해서 gcc가 빌드하도록 하는 걸로 보였다. 다른 코드 빌드할 때는 문제가 없는데 유독 ACL library에서만 이런 문제가 나서 보다 보니 아무래도 Makefile이 잘못된 듯 하다."><meta itemprop=name content="2nd patch submit to DPDK"><meta itemprop=description content="AVX2가 지원되지 않는 머신에서 쓸데없이 ACL library 빌드할 때 AVX2를 이용해서 빌드하려는 문제를 확인했다. 지금까지 아무도 고치지 않은 게 이상하긴 한데 그래도 내가 생각한 수정 방법이 제대로 동작하는 듯 해서 패치를 한번 보내보기로 했다.
수정사항은 비교적 간단하다. ACL 라이브러리 빌드할 때 AVX2를 이용해서 빌드해야 하는 경우인지를 검사하는 코드가 lib/librte_acl/Makefile에 정의되어 있는데 여기서 항상 -march=core-avx2 옵션을 사용해서 AVX2가 지원되지 않는 머신에서도 AVX2를 사용해서 gcc가 빌드하도록 하는 걸로 보였다. 다른 코드 빌드할 때는 문제가 없는데 유독 ACL library에서만 이런 문제가 나서 보다 보니 아무래도 Makefile이 잘못된 듯 하다."><meta itemprop=datePublished content="2018-07-21T15:02:14+09:00"><meta itemprop=dateModified content="2018-07-21T15:10:14+00:00"><meta itemprop=wordCount content="970"><meta itemprop=keywords content="DPDK,Homebrew,Opensource,Patch,Git,Perl"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>Keep calm and Write something</h2></a><nav><a href=/post/>Post</a>
<a href=/page/>Page</a>
<a href=/series/>Series</a>
<a href=/tags/>Tag</a>
<a href=/archive/>Archive</a>
<a href=/search/>Search</a></nav></header><main><content><p>AVX2가 지원되지 않는 머신에서 쓸데없이 ACL library 빌드할 때 AVX2를 이용해서 빌드하려는 문제를 확인했다. 지금까지 아무도 고치지 않은 게 이상하긴 한데 그래도 내가 생각한 수정 방법이 제대로 동작하는 듯 해서 패치를 한번 보내보기로 했다.</p><p>수정사항은 비교적 간단하다.
ACL 라이브러리 빌드할 때 AVX2를 이용해서 빌드해야 하는 경우인지를 검사하는 코드가 <code>lib/librte_acl/Makefile</code>에 정의되어 있는데 여기서 항상 <code>-march=core-avx2</code> 옵션을 사용해서 AVX2가 지원되지 않는 머신에서도 AVX2를 사용해서 gcc가 빌드하도록 하는 걸로 보였다. 다른 코드 빌드할 때는 문제가 없는데 유독 ACL library에서만 이런 문제가 나서 보다 보니 아무래도 Makefile이 잘못된 듯 하다.</p><p><a href=https://www.dpdk.org/contribute/>https://www.dpdk.org/contribute/</a> 페이지 내용을 참고해서</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone git://dpdk.org/dpdk
</span></span></code></pre></div><p>코드 수정</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ git commit --signoff 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mk: Detect AVX2 capability based on the target CPU architecture
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AVX2 support check should be based on the target CPU architecure.
</span></span><span style=display:flex><span>For this, -march option should be <span style=color:#66d9ef>$(</span>RTE_MACHINE<span style=color:#66d9ef>)</span> instead of core-avx2.
</span></span></code></pre></div><p>commit comment 를 수정하려면</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ git commit --amend
</span></span></code></pre></div><p>이제 patch를 생성해 보자. 최근 1개의 commit으로 패치 파일을 만드려면 <code>-</code> 옵션을 사용한다.</p><pre tabindex=0><code>$ git format-patch -1
</code></pre><p>패치 파일 내용 확인해 보고</p><pre tabindex=0><code>$ cat 0001-mk-Detect-AVX2-capability-based-on-the-target-CPU-ar.patch 
From 7bed8881339afee9bbef31638d3f15dad27efb87 Mon Sep 17 00:00:00 2001
From: Chaeyong Chong &lt;cychong@samsung.com&gt;
Date: Sat, 21 Jul 2018 22:51:19 +0900
Subject: [PATCH] mk: Detect AVX2 capability based on the target CPU
 architecture

AVX2 support check should be based on the target CPU architecure.
For this, -march option should be $(RTE_MACHINE) instead of core-avx2.

Cc: stable@dpdk.org

Signed-off-by: Chaeyong Chong &lt;cychong@samsung.com&gt;
---
 lib/librte_acl/Makefile | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lib/librte_acl/Makefile b/lib/librte_acl/Makefile
index ea5edf00a..c756eaeb2 100644
--- a/lib/librte_acl/Makefile
+++ b/lib/librte_acl/Makefile
@@ -44,7 +44,7 @@ ifeq ($(findstring RTE_MACHINE_CPUFLAG_AVX2,$(CFLAGS)),RTE_MACHINE_CPUFLAG_AVX2)
 	CC_AVX2_SUPPORT=1
 else
 	CC_AVX2_SUPPORT=\
-	$(shell $(CC) -march=core-avx2 -dM -E - &lt;/dev/null 2&gt;&amp;1 | \
+	$(shell $(CC) -march=$(RTE_MACHINE) -dM -E - &lt;/dev/null 2&gt;&amp;1 | \
 	grep -q AVX2 &amp;&amp; echo 1)
 	ifeq ($(CC_AVX2_SUPPORT), 1)
 		ifeq ($(CONFIG_RTE_TOOLCHAIN_ICC),y)
-- 
2.18.0    
</code></pre><p>git에서 바로 패치 내용을 전송할 수 있는데 그러려면 SMTP 관련 설정을 해 봐야 한다. 관련 파일은
<code>~/.gitconfig</code> 이거나 git repo에 있는 <code>.git/config</code></p><pre tabindex=0><code>[sendemail]
from = Chaeyong Chong &lt;cychong@gmail.com&gt;
smtpserver = smtp.gmail.com
smtpuser = cychong@gmail.com
smtpencryption = tls
smtppass = XXXXXXX
chainreplyto = false
smtpserverport = 587
</code></pre><p>이제 보내볼까?</p><pre tabindex=0><code>mbpr15:dpdk cychong$ git send-email --to konstantin.ananyev@intel.com --cc dev@dpdk.org 0001-mk-Detect-AVX2-capability-based-on-the-target-CPU-ar.patch 
0001-mk-Detect-AVX2-capability-based-on-the-target-CPU-ar.patch
(mbox) Adding cc: Chaeyong Chong &lt;cychong@samsung.com&gt; from line &#39;From: Chaeyong Chong &lt;cychong@samsung.com&gt;&#39;
(body) Adding cc: stable@dpdk.org from line &#39;Cc: stable@dpdk.org&#39;
(body) Adding cc: Chaeyong Chong &lt;cychong@samsung.com&gt; from line &#39;Signed-off-by: Chaeyong Chong &lt;cychong@samsung.com&gt;&#39;

From: Chaeyong Chong &lt;cychong@gmail.com&gt;
To: konstantin.ananyev@intel.com
Cc: dev@dpdk.org,
	Chaeyong Chong &lt;cychong@samsung.com&gt;,
	stable@dpdk.org
Subject: [PATCH] mk: Detect AVX2 capability based on the target CPU architecture
Date: Sat, 21 Jul 2018 23:06:23 +0900
Message-Id: &lt;20180721140623.1293-1-cychong@gmail.com&gt;
X-Mailer: git-send-email 2.18.0

    The Cc list above has been expanded by additional
    addresses found in the patch commit message. By default
    send-email prompts before sending whenever this occurs.
    This behavior is controlled by the sendemail.confirm
    configuration setting.

    For additional information, run &#39;git send-email --help&#39;.
    To retain the current behavior, but squelch this message,
    run &#39;git config --global sendemail.confirm auto&#39;.

Send this email? ([y]es|[n]o|[e]dit|[q]uit|[a]ll): y
Can&#39;t locate Net/SMTP/SSL.pm in @INC (you may need to install the Net::SMTP::SSL module) (@INC contains: /usr/local/Cellar/git/2.18.0/share/perl5 /Applications/Xcode.app/Contents/Developer/Library/Perl/5.18/darwin-thread-multi-2level /Library/Developer/CommandLineTools/Library/Perl/5.18/darwin-thread-multi-2level /Library/Perl/5.18/darwin-thread-multi-2level /Library/Perl/5.18 /Network/Library/Perl/5.18/darwin-thread-multi-2level /Network/Library/Perl/5.18 /Library/Perl/Updates/5.18.2 /System/Library/Perl/5.18/darwin-thread-multi-2level /System/Library/Perl/5.18 /System/Library/Perl/Extras/5.18/darwin-thread-multi-2level /System/Library/Perl/Extras/5.18 .) at /usr/local/Cellar/git/2.18.0/libexec/git-core/git-send-email line 1497.
</code></pre><p>무슨 에러가 난다. Perl 관련 에러로 보이는데 마땅한 해결책이 없나 보다. 인터넷을 뒤져 해결책을 찾아 적용해봤지만 백약이 무효</p><p>원인을 찾아 보니 위 에러 메시지의 마지막에 있는 것처럼 git-send-email 파일 1497 라인에서 <code>Net/SMTP/SSL.pm</code>을 찾는 데 못찾고 있다는 거. 근데 그냥 perl로 확인해 보면 멀쩡히 @INC 경로에 포함되어 있다는 사실</p><p>흥미로운 건 어디에 있는 perl을 쓰느냐에 따라 모듈 위치가 달라진 다는 거</p><p>이건 OS X에 기본 내장된 perl을 사용한 경우</p><pre tabindex=0><code>$/usr/bin/perl -e &#39;print &#34;@INC&#34;;&#39;
/Library/Perl/5.18/darwin-thread-multi-2level /Library/Perl/5.18 /Network/Library/Perl/5.18/darwin-thread-multi-2level /Network/Library/Perl/5.18 /Library/Perl/Updates/5.18.2 /System/Library/Perl/5.18/darwin-thread-multi-2level /System/Library/Perl/5.18 /System/Library/Perl/Extras/5.18/darwin-thread-multi-2level /System/Library/Perl/Extras/5.18 .
</code></pre><p>이건 homebrew로 설치한 <code>perl</code>이 찾는 위치</p><pre tabindex=0><code>mbpr15:dpdk cychong$ perl -e &#39;print &#34;@INC&#34;;&#39;
/usr/local/Cellar/perl/5.28.0/lib/perl5/site_perl/5.28.0/darwin-thread-multi-2level /usr/local/Cellar/perl/5.28.0/lib/perl5/site_perl/5.28.0 /usr/local/Cellar/perl/5.28.0/lib/perl5/5.28.0/darwin-thread-multi-2level /usr/local/Cellar/perl/5.28.0/lib/perl5/5.28.0 /usr/local/lib/perl5/site_perl/5.28.0/darwin-thread-multi-2level /usr/local/lib/perl5/site_perl/5.28.0
</code></pre><p>그리고 <code>git send-email</code> 명령이 못찾고 있는 <code>SSL.pm</code>의 위치는 이미 <code>/usr/bin/perl</code>이 아닌 그냥 perl(실제는 <code>/usr/local/bin/perl</code>의 모듈 경로에 이미 포함되어 있다는</p><pre tabindex=0><code>mbpr15:dpdk cychong$ find / -name SSL.pm
find: /usr/sbin/authserver: Permission denied
/usr/local/Cellar/perl/5.28.0/lib/perl5/site_perl/5.28.0/Net/SMTP/SSL.pm
</code></pre><p>그래서 <code>/usr/local/Cellar/git/2.18.0/libexec/git-core/git-send-email</code> 이 brew 버전의 perl을 사용하도록 변경 후 다시 <code>git send-email</code> 시도</p><pre tabindex=0><code>Send this email? ([y]es|[n]o|[e]dit|[q]uit|[a]ll): a
Need MIME::Base64 and Authen::SASL todo auth at /usr/local/Cellar/git/2.18.0/libexec/git-core/git-send-email line 1521.
</code></pre><p>이것 쯤이야 이젠 쉽게(?) 해결</p><pre tabindex=0><code>mbpr15:dpdk cychong$ sudo -H cpan MIME:Base64
...

mbpr15:dpdk cychong$ sudo -H cpan Authen::SASL
...
</code></pre><p>이젠 정말 되겠지?</p><pre tabindex=0><code>Send this email? ([y]es|[n]o|[e]dit|[q]uit|[a]ll): y
5.7.9 Application-specific password required. Learn more at
5.7.9  https://support.google.com/mail/?p=InvalidSecondFactor q81-v6sm10686681pfd.15 - gsmtp
</code></pre><p>음.. 깔끔하게 되었다는 말은 안 나오지만 그래도 이 메시지는 일단 메일 전송 요청을 받은 gmail server에서 보낸 걸로 보아 전송에 필요한 git 관련 이슈는 없나 보다. 이제 이 문제만 해결하면 이메일을 보낼 수 있겠다.
구글에서 <code>gmail Application-specific password required</code> 로 찾은 내용을 참고해서 gmail에 대해 mac에서 전송할 때 사용할 암호를 따로 지정. 왜 이렇게 해야 하는 지도 설명되어 있지만 일단 보내고 보자.</p><pre tabindex=0><code>mbpr15:dpdk cychong$ git send-email --to konstantin.ananyev@intel.com --cc dev@dpdk.org 0001-mk-Detect-AVX2-capability-based-on-the-target-CPU-ar.patch 
0001-mk-Detect-AVX2-capability-based-on-the-target-CPU-ar.patch
(mbox) Adding cc: Chaeyong Chong &lt;cychong@samsung.com&gt; from line &#39;From: Chaeyong Chong &lt;cychong@samsung.com&gt;&#39;
(body) Adding cc: stable@dpdk.org from line &#39;Cc: stable@dpdk.org&#39;
(body) Adding cc: Chaeyong Chong &lt;cychong@samsung.com&gt; from line &#39;Signed-off-by: Chaeyong Chong &lt;cychong@samsung.com&gt;&#39;

From: Chaeyong Chong &lt;cychong@gmail.com&gt;
To: konstantin.ananyev@intel.com
Cc: dev@dpdk.org,
	Chaeyong Chong &lt;cychong@samsung.com&gt;,
	stable@dpdk.org
Subject: [PATCH] mk: Detect AVX2 capability based on the target CPU architecture
Date: Sat, 21 Jul 2018 23:53:42 +0900
Message-Id: &lt;20180721145342.6503-1-cychong@gmail.com&gt;
X-Mailer: git-send-email 2.18.0

    The Cc list above has been expanded by additional
    addresses found in the patch commit message. By default
    send-email prompts before sending whenever this occurs.
    This behavior is controlled by the sendemail.confirm
    configuration setting.

    For additional information, run &#39;git send-email --help&#39;.
    To retain the current behavior, but squelch this message,
    run &#39;git config --global sendemail.confirm auto&#39;.

Send this email? ([y]es|[n]o|[e]dit|[q]uit|[a]ll): a
OK. Log says:
Server: smtp.gmail.com
MAIL FROM:&lt;cychong@gmail.com&gt;
RCPT TO:&lt;konstantin.ananyev@intel.com&gt;
RCPT TO:&lt;dev@dpdk.org&gt;
RCPT TO:&lt;cychong@samsung.com&gt;
RCPT TO:&lt;stable@dpdk.org&gt;
From: Chaeyong Chong &lt;cychong@gmail.com&gt;
To: konstantin.ananyev@intel.com
Cc: dev@dpdk.org,
	Chaeyong Chong &lt;cychong@samsung.com&gt;,
	stable@dpdk.org
Subject: [PATCH] mk: Detect AVX2 capability based on the target CPU architecture
Date: Sat, 21 Jul 2018 23:53:42 +0900
Message-Id: &lt;20180721145342.6503-1-cychong@gmail.com&gt;
X-Mailer: git-send-email 2.18.0

Result: 250 
mbpr15:dpdk cychong$ 
</code></pre><p>Result 250은 SMTP result code로 정상적으로 전송되었다는 의미란다.(<a href=https://www.greenend.org.uk/rjk/tech/smtpreplies.html>https://www.greenend.org.uk/rjk/tech/smtpreplies.html</a>)</p><p>드디어 끝났다.</p></content><p><a href=https://cychong47.github.io/tags/dpdk/>#DPDK</a>
<a href=https://cychong47.github.io/tags/homebrew/>#Homebrew</a>
<a href=https://cychong47.github.io/tags/opensource/>#Opensource</a>
<a href=https://cychong47.github.io/tags/patch/>#Patch</a>
<a href=https://cychong47.github.io/tags/git/>#Git</a>
<a href=https://cychong47.github.io/tags/perl/>#Perl</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>