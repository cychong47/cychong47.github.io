<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Helmize Slackbot | Keep calm and Write something</title><meta name=title content="Helmize Slackbot"><meta name=description content='docker로 실행할 대는 환경 변수 파일에 필요한 token정보 등을 적어서 넘겼는데
docker run -d -p 3010:3010 --env-file=slackbot.env my-slackbot
helm으로 할 때는 configmap을 사용하거나, value의 env를 사용하거나 등등.
$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "infracloudio" chart repository
...Successfully got an update from the "myhelmrepo" chart repository
Update Complete. ⎈Happy Helming!⎈

$ helm search repo slackbot
NAME               	CHART VERSION	APP VERSION	DESCRIPTION                
myhelmrepo/slackbot	0.1.0        	1.16.0     	A Helm chart for Kubernetes
$ helm install -f ../../slackbot-value.yaml --version 0.1.0 slackbot myhelmrepo/slackbot
NAME: slackbot
LAST DEPLOYED: Thu Sep 10 09:47:26 2020
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services slackbot)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
slackbot-value.yaml파일의 환경 변수에 필요한 token 정보들을 기술'><meta name=keywords content="docker,kubernetes,helm,readiness,"><meta property="og:url" content="https://cychong47.github.io/post/2020/2020-09-10-helmize-slackbot/"><meta property="og:site_name" content="Keep calm and Write something"><meta property="og:title" content="Helmize Slackbot"><meta property="og:description" content='docker로 실행할 대는 환경 변수 파일에 필요한 token정보 등을 적어서 넘겼는데
docker run -d -p 3010:3010 --env-file=slackbot.env my-slackbot helm으로 할 때는 configmap을 사용하거나, value의 env를 사용하거나 등등.
$ helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the "infracloudio" chart repository ...Successfully got an update from the "myhelmrepo" chart repository Update Complete. ⎈Happy Helming!⎈ $ helm search repo slackbot NAME CHART VERSION	APP VERSION	DESCRIPTION myhelmrepo/slackbot	0.1.0 1.16.0 A Helm chart for Kubernetes $ helm install -f ../../slackbot-value.yaml --version 0.1.0 slackbot myhelmrepo/slackbot NAME: slackbot LAST DEPLOYED: Thu Sep 10 09:47:26 2020 NAMESPACE: default STATUS: deployed REVISION: 1 NOTES: 1. Get the application URL by running these commands: export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services slackbot) export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}") echo http://$NODE_IP:$NODE_PORT slackbot-value.yaml파일의 환경 변수에 필요한 token 정보들을 기술'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-09-10T23:38:18+09:00"><meta property="article:modified_time" content="2020-09-10T23:38:18+09:00"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Helm"><meta property="article:tag" content="Readiness"><meta property="og:see_also" content="https://cychong47.github.io/post/2020/2020-10-19-use-the-secret-and-configmaps/"><meta property="og:see_also" content="https://cychong47.github.io/post/2020/2020-10-19-how-to-fix-no-timezone-support-of-cronjob/"><meta property="og:see_also" content="https://cychong47.github.io/post/2020/2020-10-09-cronjob-in-kubernetes/"><meta property="og:see_also" content="https://cychong47.github.io/post/2020/2020-10-09-job-instead-of-deployment/"><meta property="og:see_also" content="https://cychong47.github.io/post/2020/new-things-in-last-4-years/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Helmize Slackbot"><meta name=twitter:description content='docker로 실행할 대는 환경 변수 파일에 필요한 token정보 등을 적어서 넘겼는데
docker run -d -p 3010:3010 --env-file=slackbot.env my-slackbot helm으로 할 때는 configmap을 사용하거나, value의 env를 사용하거나 등등.
$ helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the "infracloudio" chart repository ...Successfully got an update from the "myhelmrepo" chart repository Update Complete. ⎈Happy Helming!⎈ $ helm search repo slackbot NAME CHART VERSION	APP VERSION	DESCRIPTION myhelmrepo/slackbot	0.1.0 1.16.0 A Helm chart for Kubernetes $ helm install -f ../../slackbot-value.yaml --version 0.1.0 slackbot myhelmrepo/slackbot NAME: slackbot LAST DEPLOYED: Thu Sep 10 09:47:26 2020 NAMESPACE: default STATUS: deployed REVISION: 1 NOTES: 1. Get the application URL by running these commands: export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services slackbot) export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}") echo http://$NODE_IP:$NODE_PORT slackbot-value.yaml파일의 환경 변수에 필요한 token 정보들을 기술'><meta itemprop=name content="Helmize Slackbot"><meta itemprop=description content='docker로 실행할 대는 환경 변수 파일에 필요한 token정보 등을 적어서 넘겼는데
docker run -d -p 3010:3010 --env-file=slackbot.env my-slackbot helm으로 할 때는 configmap을 사용하거나, value의 env를 사용하거나 등등.
$ helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the "infracloudio" chart repository ...Successfully got an update from the "myhelmrepo" chart repository Update Complete. ⎈Happy Helming!⎈ $ helm search repo slackbot NAME CHART VERSION	APP VERSION	DESCRIPTION myhelmrepo/slackbot	0.1.0 1.16.0 A Helm chart for Kubernetes $ helm install -f ../../slackbot-value.yaml --version 0.1.0 slackbot myhelmrepo/slackbot NAME: slackbot LAST DEPLOYED: Thu Sep 10 09:47:26 2020 NAMESPACE: default STATUS: deployed REVISION: 1 NOTES: 1. Get the application URL by running these commands: export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services slackbot) export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}") echo http://$NODE_IP:$NODE_PORT slackbot-value.yaml파일의 환경 변수에 필요한 token 정보들을 기술'><meta itemprop=datePublished content="2020-09-10T23:38:18+09:00"><meta itemprop=dateModified content="2020-09-10T23:38:18+09:00"><meta itemprop=wordCount content="491"><meta itemprop=keywords content="Docker,Kubernetes,Helm,Readiness"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>Keep calm and Write something</h2></a><nav><a href=/post/>Post</a>
<a href=/page/>Page</a>
<a href=/series/>Series</a>
<a href=/tags/>Tag</a>
<a href=/archive/>Archive</a>
<a href=/search/>Search</a></nav></header><main><content><p>docker로 실행할 대는 환경 변수 파일에 필요한 token정보 등을 적어서 넘겼는데</p><pre tabindex=0><code>docker run -d -p 3010:3010 --env-file=slackbot.env my-slackbot
</code></pre><p>helm으로 할 때는 configmap을 사용하거나, value의 <code>env</code>를 사용하거나 등등.</p><pre tabindex=0><code>$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the &#34;infracloudio&#34; chart repository
...Successfully got an update from the &#34;myhelmrepo&#34; chart repository
Update Complete. ⎈Happy Helming!⎈

$ helm search repo slackbot
NAME               	CHART VERSION	APP VERSION	DESCRIPTION                
myhelmrepo/slackbot	0.1.0        	1.16.0     	A Helm chart for Kubernetes
</code></pre><pre tabindex=0><code>$ helm install -f ../../slackbot-value.yaml --version 0.1.0 slackbot myhelmrepo/slackbot
NAME: slackbot
LAST DEPLOYED: Thu Sep 10 09:47:26 2020
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath=&#34;{.spec.ports[0].nodePort}&#34; services slackbot)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath=&#34;{.items[0].status.addresses[0].address}&#34;)
  echo http://$NODE_IP:$NODE_PORT
</code></pre><p><code>slackbot-value.yaml</code>파일의 환경 변수에 필요한 token 정보들을 기술</p><pre tabindex=0><code>$ cat ../../slackbot-value.yaml 

env:
  slack_api_token: XXX
  slack_events_token: YYY
  slack_signing_secret: ZZZ
  verification_token: AAA
  tz: Asia/Seoul
</code></pre><p>잠시 후 띠릭띠릭 하고 slack에서 notification이 올라오는데 흠.. 결과를 에러…</p><p><img src=/images/2020/09/2020-09-10-helmize-slackbot-failed.png alt></p><pre tabindex=0><code>$ kubectl get pods
NAME                             READY   STATUS    RESTARTS   AGE
podcast-nginx-659bcb6485-vc6lb   1/1     Running   2          69d
slackbot-86bd64f8bf-84b7c        0/1     Running   3          3m26s
sosa0sa-nginx-87fc9949c-462s6    1/1     Running   1          5d10h

$ kubectl get svc
NAME            TYPE        CLUSTER-IP      EXTERNAL-IP     PORT(S)          AGE
kubernetes      ClusterIP   10.96.0.1       &lt;none&gt;          443/TCP          367d
podcast-nginx   NodePort    10.102.38.142   192.168.1.100   8099:32529/TCP   69d
slackbot        NodePort    10.96.167.110   &lt;none&gt;          3010:31144/TCP   3m32s
sosa0sa-nginx   NodePort    10.99.91.25     192.168.1.100   80:32492/TCP     22d
</code></pre><p>흠. Pod는 정상적으로 deploy가 되었는데 뭔가 좀 이상하네…. 일단 external IP가 없고.
이러면 외부에서 통신이 안될텐데…..
혹시나 하고 slack에서 talk을 걸어보지만 무심한 당신은 답변이 없네.</p><p><img src=/images/2020/09/2020-09-10-helmize-slackbot-no-reply.png alt></p><p>저건 service 설정이 잘못된 건데.</p><p>Helm chart의 <code>template/service.yaml</code> 파일에 NodePort를 사용하도록 변경하고 Helm chart 를 다시 업로드한 후 다시 시도 [[Helm chart 버전 변경]]</p><pre tabindex=0><code>$ helm install -f slackbot-value.yaml --version 0.2.0 slackbot myhelmrepo/slackbot
NAME: slackbot
LAST DEPLOYED: Thu Sep 10 10:28:48 2020
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath=&#34;{.spec.ports[0].nodePort}&#34; services slackbot)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath=&#34;{.items[0].status.addresses[0].address}&#34;)
  echo http://$NODE_IP:$NODE_PORT

$ kubectl get svc
NAME            TYPE        CLUSTER-IP      EXTERNAL-IP     PORT(S)          AGE
kubernetes      ClusterIP   10.96.0.1       &lt;none&gt;          443/TCP          367d
podcast-nginx   NodePort    10.102.38.142   192.168.1.100   8099:32529/TCP   69d
slackbot        NodePort    10.103.61.67    192.168.1.100   3010:31407/TCP   25s
sosa0sa-nginx   NodePort    10.99.91.25     192.168.1.100   80:32492/TCP     22d
</code></pre><p>이전과 달리 NodePort 관련 에러는 없어졌다. 여전히 Readiness와 Liveness 에러는 있지만.</p><p><img src=/images/2020/09/2020-09-10-helmize-slackbot-nodeport-is-fixed.png alt></p><pre tabindex=0><code>$ kubectl get pods
NAME                             READY   STATUS    RESTARTS   AGE
podcast-nginx-659bcb6485-vc6lb   1/1     Running   2          69d
slackbot-86bd64f8bf-jhckf        0/1     Running   3          3m6s
sosa0sa-nginx-87fc9949c-462s6    1/1     Running   1          5d10h
</code></pre><p>이전에 K8s에 올린 것들은 모두 nginx나 ghost 같이 기본적인 처리(?)를 해줘서 저런 문제가 없었나 보다.
Flask에도 readiness, liveness를 추가해야겠다. [[Readiness and Liveness in flask]]</p><h2 id=liveness-추가>Liveness 추가</h2><p>[[Readiness and Liveness in flask]] 후에 드디어 정상적으로 flask 기반의 slackbot이 정상적으로 동작한다.</p><pre tabindex=0><code>$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the &#34;infracloudio&#34; chart repository
...Successfully got an update from the &#34;myhelmrepo&#34; chart repository
Update Complete. ⎈Happy Helming!⎈

@mini1:~/work/helm/helm-chart$ helm search repo slackbot
NAME               	CHART VERSION	APP VERSION	DESCRIPTION                
myhelmrepo/slackbot	0.3.0        	1.16.0     	A Helm chart for Kubernetes
</code></pre><p><img src=/images/2020/09/2020-09-10-helmize-slackbot-deployed.png alt></p><p><img src=/images/2020/09/2020-09-10-helmize-slackbot-delete.png alt><br><img src=/images/2020/09/2020-09-10-helmize-slackbot-readiness-failed-again.png alt></p></content><p><a href=https://cychong47.github.io/tags/docker/>#Docker</a>
<a href=https://cychong47.github.io/tags/kubernetes/>#Kubernetes</a>
<a href=https://cychong47.github.io/tags/helm/>#Helm</a>
<a href=https://cychong47.github.io/tags/readiness/>#Readiness</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>