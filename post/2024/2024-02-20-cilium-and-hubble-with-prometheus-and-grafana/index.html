<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Monitoring Cilium and Hubble with Prometheus and Grafana | Keep calm and Write something</title><meta name=title content="Monitoring Cilium and Hubble with Prometheus and Grafana"><meta name=description content='Setup Prometheus and Grafana to scrap Cilium metrics
This will create a new namespace cilium-monitoring
kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.15.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml
Some warnings&mldr;
namespace/cilium-monitoring created
serviceaccount/prometheus-k8s created
configmap/grafana-config created
configmap/grafana-cilium-dashboard created
configmap/grafana-cilium-operator-dashboard created
configmap/grafana-hubble-dashboard created
configmap/grafana-hubble-l7-http-metrics-by-workload created
configmap/prometheus created
clusterrole.rbac.authorization.k8s.io/prometheus created
clusterrolebinding.rbac.authorization.k8s.io/prometheus created
service/grafana created
service/prometheus created
Warning: would violate PodSecurity "restricted:latest": allowPrivilegeEscalation != false (container "grafana-core" must set securityContext.allowPrivilegeEscalation=false), unrestricted capabilities (container "grafana-core" must set securityContext.capabilities.drop=["ALL"]), runAsNonRoot != true (pod or container "grafana-core" must set securityContext.runAsNonRoot=true), seccompProfile (pod or container "grafana-core" must set securityContext.seccompProfile.type to "RuntimeDefault" or "Localhost")
deployment.apps/grafana created
Warning: would violate PodSecurity "restricted:latest": allowPrivilegeEscalation != false (container "prometheus" must set securityContext.allowPrivilegeEscalation=false), unrestricted capabilities (container "prometheus" must set securityContext.capabilities.drop=["ALL"]), runAsNonRoot != true (pod or container "prometheus" must set securityContext.runAsNonRoot=true), seccompProfile (pod or container "prometheus" must set securityContext.seccompProfile.type to "RuntimeDefault" or "Localhost")
deployment.apps/prometheus created
kubectl get all
❯ kubectl get all -n cilium-monitoring 
NAME                              READY   STATUS    RESTARTS   AGE
pod/grafana-6f4755f98c-8c7sg      1/1     Running   0          57s
pod/prometheus-67fdcf4796-vc8hd   1/1     Running   0          57s

NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/grafana      ClusterIP   10.102.147.187   <none>        3000/TCP   57s
service/prometheus   ClusterIP   10.104.8.139     <none>        9090/TCP   57s

NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/grafana      1/1     1            1           57s
deployment.apps/prometheus   1/1     1            1           57s

NAME                                    DESIRED   CURRENT   READY   AGE
replicaset.apps/grafana-6f4755f98c      1         1         1       57s
replicaset.apps/prometheus-67fdcf4796   1         1         1       57s
Change service type to LoadBalancer
❯ kubectl patch svc prometheus -n cilium-monitoring -p &#39;{"spec": {"type": "LoadBalancer"}}&#39;

❯ kubectl patch svc grafana -n cilium-monitoring -p &#39;{"spec": {"type": "LoadBalancer"}}&#39;
Now TYPE is LoadBalancer and EXTERNAL-IP is assigned for each service'><meta name=keywords content="til,cilium,prometheus,grafana,"><meta property="og:url" content="https://cychong47.github.io/post/2024/2024-02-20-cilium-and-hubble-with-prometheus-and-grafana/"><meta property="og:site_name" content="Keep calm and Write something"><meta property="og:title" content="Monitoring Cilium and Hubble with Prometheus and Grafana"><meta property="og:description" content='Setup Prometheus and Grafana to scrap Cilium metrics This will create a new namespace cilium-monitoring
kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.15.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml Some warnings… namespace/cilium-monitoring created serviceaccount/prometheus-k8s created configmap/grafana-config created configmap/grafana-cilium-dashboard created configmap/grafana-cilium-operator-dashboard created configmap/grafana-hubble-dashboard created configmap/grafana-hubble-l7-http-metrics-by-workload created configmap/prometheus created clusterrole.rbac.authorization.k8s.io/prometheus created clusterrolebinding.rbac.authorization.k8s.io/prometheus created service/grafana created service/prometheus created Warning: would violate PodSecurity "restricted:latest": allowPrivilegeEscalation != false (container "grafana-core" must set securityContext.allowPrivilegeEscalation=false), unrestricted capabilities (container "grafana-core" must set securityContext.capabilities.drop=["ALL"]), runAsNonRoot != true (pod or container "grafana-core" must set securityContext.runAsNonRoot=true), seccompProfile (pod or container "grafana-core" must set securityContext.seccompProfile.type to "RuntimeDefault" or "Localhost") deployment.apps/grafana created Warning: would violate PodSecurity "restricted:latest": allowPrivilegeEscalation != false (container "prometheus" must set securityContext.allowPrivilegeEscalation=false), unrestricted capabilities (container "prometheus" must set securityContext.capabilities.drop=["ALL"]), runAsNonRoot != true (pod or container "prometheus" must set securityContext.runAsNonRoot=true), seccompProfile (pod or container "prometheus" must set securityContext.seccompProfile.type to "RuntimeDefault" or "Localhost") deployment.apps/prometheus created kubectl get all ❯ kubectl get all -n cilium-monitoring NAME READY STATUS RESTARTS AGE pod/grafana-6f4755f98c-8c7sg 1/1 Running 0 57s pod/prometheus-67fdcf4796-vc8hd 1/1 Running 0 57s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/grafana ClusterIP 10.102.147.187 <none> 3000/TCP 57s service/prometheus ClusterIP 10.104.8.139 <none> 9090/TCP 57s NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/grafana 1/1 1 1 57s deployment.apps/prometheus 1/1 1 1 57s NAME DESIRED CURRENT READY AGE replicaset.apps/grafana-6f4755f98c 1 1 1 57s replicaset.apps/prometheus-67fdcf4796 1 1 1 57s Change service type to LoadBalancer ❯ kubectl patch svc prometheus -n cilium-monitoring -p &#39;{"spec": {"type": "LoadBalancer"}}&#39; ❯ kubectl patch svc grafana -n cilium-monitoring -p &#39;{"spec": {"type": "LoadBalancer"}}&#39; Now TYPE is LoadBalancer and EXTERNAL-IP is assigned for each service'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-02-20T00:00:00+00:00"><meta property="article:modified_time" content="2024-02-20T00:00:00+00:00"><meta property="article:tag" content="Til"><meta property="article:tag" content="Cilium"><meta property="article:tag" content="Prometheus"><meta property="article:tag" content="Grafana"><meta name=twitter:card content="summary"><meta name=twitter:title content="Monitoring Cilium and Hubble with Prometheus and Grafana"><meta name=twitter:description content='Setup Prometheus and Grafana to scrap Cilium metrics This will create a new namespace cilium-monitoring
kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.15.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml Some warnings… namespace/cilium-monitoring created serviceaccount/prometheus-k8s created configmap/grafana-config created configmap/grafana-cilium-dashboard created configmap/grafana-cilium-operator-dashboard created configmap/grafana-hubble-dashboard created configmap/grafana-hubble-l7-http-metrics-by-workload created configmap/prometheus created clusterrole.rbac.authorization.k8s.io/prometheus created clusterrolebinding.rbac.authorization.k8s.io/prometheus created service/grafana created service/prometheus created Warning: would violate PodSecurity "restricted:latest": allowPrivilegeEscalation != false (container "grafana-core" must set securityContext.allowPrivilegeEscalation=false), unrestricted capabilities (container "grafana-core" must set securityContext.capabilities.drop=["ALL"]), runAsNonRoot != true (pod or container "grafana-core" must set securityContext.runAsNonRoot=true), seccompProfile (pod or container "grafana-core" must set securityContext.seccompProfile.type to "RuntimeDefault" or "Localhost") deployment.apps/grafana created Warning: would violate PodSecurity "restricted:latest": allowPrivilegeEscalation != false (container "prometheus" must set securityContext.allowPrivilegeEscalation=false), unrestricted capabilities (container "prometheus" must set securityContext.capabilities.drop=["ALL"]), runAsNonRoot != true (pod or container "prometheus" must set securityContext.runAsNonRoot=true), seccompProfile (pod or container "prometheus" must set securityContext.seccompProfile.type to "RuntimeDefault" or "Localhost") deployment.apps/prometheus created kubectl get all ❯ kubectl get all -n cilium-monitoring NAME READY STATUS RESTARTS AGE pod/grafana-6f4755f98c-8c7sg 1/1 Running 0 57s pod/prometheus-67fdcf4796-vc8hd 1/1 Running 0 57s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/grafana ClusterIP 10.102.147.187 <none> 3000/TCP 57s service/prometheus ClusterIP 10.104.8.139 <none> 9090/TCP 57s NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/grafana 1/1 1 1 57s deployment.apps/prometheus 1/1 1 1 57s NAME DESIRED CURRENT READY AGE replicaset.apps/grafana-6f4755f98c 1 1 1 57s replicaset.apps/prometheus-67fdcf4796 1 1 1 57s Change service type to LoadBalancer ❯ kubectl patch svc prometheus -n cilium-monitoring -p &#39;{"spec": {"type": "LoadBalancer"}}&#39; ❯ kubectl patch svc grafana -n cilium-monitoring -p &#39;{"spec": {"type": "LoadBalancer"}}&#39; Now TYPE is LoadBalancer and EXTERNAL-IP is assigned for each service'><meta itemprop=name content="Monitoring Cilium and Hubble with Prometheus and Grafana"><meta itemprop=description content='Setup Prometheus and Grafana to scrap Cilium metrics This will create a new namespace cilium-monitoring
kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.15.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml Some warnings… namespace/cilium-monitoring created serviceaccount/prometheus-k8s created configmap/grafana-config created configmap/grafana-cilium-dashboard created configmap/grafana-cilium-operator-dashboard created configmap/grafana-hubble-dashboard created configmap/grafana-hubble-l7-http-metrics-by-workload created configmap/prometheus created clusterrole.rbac.authorization.k8s.io/prometheus created clusterrolebinding.rbac.authorization.k8s.io/prometheus created service/grafana created service/prometheus created Warning: would violate PodSecurity "restricted:latest": allowPrivilegeEscalation != false (container "grafana-core" must set securityContext.allowPrivilegeEscalation=false), unrestricted capabilities (container "grafana-core" must set securityContext.capabilities.drop=["ALL"]), runAsNonRoot != true (pod or container "grafana-core" must set securityContext.runAsNonRoot=true), seccompProfile (pod or container "grafana-core" must set securityContext.seccompProfile.type to "RuntimeDefault" or "Localhost") deployment.apps/grafana created Warning: would violate PodSecurity "restricted:latest": allowPrivilegeEscalation != false (container "prometheus" must set securityContext.allowPrivilegeEscalation=false), unrestricted capabilities (container "prometheus" must set securityContext.capabilities.drop=["ALL"]), runAsNonRoot != true (pod or container "prometheus" must set securityContext.runAsNonRoot=true), seccompProfile (pod or container "prometheus" must set securityContext.seccompProfile.type to "RuntimeDefault" or "Localhost") deployment.apps/prometheus created kubectl get all ❯ kubectl get all -n cilium-monitoring NAME READY STATUS RESTARTS AGE pod/grafana-6f4755f98c-8c7sg 1/1 Running 0 57s pod/prometheus-67fdcf4796-vc8hd 1/1 Running 0 57s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/grafana ClusterIP 10.102.147.187 <none> 3000/TCP 57s service/prometheus ClusterIP 10.104.8.139 <none> 9090/TCP 57s NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/grafana 1/1 1 1 57s deployment.apps/prometheus 1/1 1 1 57s NAME DESIRED CURRENT READY AGE replicaset.apps/grafana-6f4755f98c 1 1 1 57s replicaset.apps/prometheus-67fdcf4796 1 1 1 57s Change service type to LoadBalancer ❯ kubectl patch svc prometheus -n cilium-monitoring -p &#39;{"spec": {"type": "LoadBalancer"}}&#39; ❯ kubectl patch svc grafana -n cilium-monitoring -p &#39;{"spec": {"type": "LoadBalancer"}}&#39; Now TYPE is LoadBalancer and EXTERNAL-IP is assigned for each service'><meta itemprop=datePublished content="2024-02-20T00:00:00+00:00"><meta itemprop=dateModified content="2024-02-20T00:00:00+00:00"><meta itemprop=wordCount content="373"><meta itemprop=keywords content="Til,Cilium,Prometheus,Grafana"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>Keep calm and Write something</h2></a><nav><a href=/post/>Post</a>
<a href=/page/>Page</a>
<a href=/series/>Series</a>
<a href=/tags/>Tag</a>
<a href=/archive/>Archive</a>
<a href=/search/>Search</a></nav></header><main><content><h2 id=setup-prometheus-and-grafana-to-scrap-cilium-metrics>Setup Prometheus and Grafana to scrap Cilium metrics</h2><p>This will create a new namespace <code>cilium-monitoring</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.15.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml
</span></span></code></pre></div><h3 id=some-warnings>Some warnings&mldr;</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>namespace/cilium-monitoring created
</span></span><span style=display:flex><span>serviceaccount/prometheus-k8s created
</span></span><span style=display:flex><span>configmap/grafana-config created
</span></span><span style=display:flex><span>configmap/grafana-cilium-dashboard created
</span></span><span style=display:flex><span>configmap/grafana-cilium-operator-dashboard created
</span></span><span style=display:flex><span>configmap/grafana-hubble-dashboard created
</span></span><span style=display:flex><span>configmap/grafana-hubble-l7-http-metrics-by-workload created
</span></span><span style=display:flex><span>configmap/prometheus created
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io/prometheus created
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io/prometheus created
</span></span><span style=display:flex><span>service/grafana created
</span></span><span style=display:flex><span>service/prometheus created
</span></span><span style=display:flex><span>Warning: would violate PodSecurity <span style=color:#e6db74>&#34;restricted:latest&#34;</span>: allowPrivilegeEscalation !<span style=color:#f92672>=</span> false <span style=color:#f92672>(</span>container <span style=color:#e6db74>&#34;grafana-core&#34;</span> must set securityContext.allowPrivilegeEscalation<span style=color:#f92672>=</span>false<span style=color:#f92672>)</span>, unrestricted capabilities <span style=color:#f92672>(</span>container <span style=color:#e6db74>&#34;grafana-core&#34;</span> must set securityContext.capabilities.drop<span style=color:#f92672>=[</span><span style=color:#e6db74>&#34;ALL&#34;</span><span style=color:#f92672>])</span>, runAsNonRoot !<span style=color:#f92672>=</span> true <span style=color:#f92672>(</span>pod or container <span style=color:#e6db74>&#34;grafana-core&#34;</span> must set securityContext.runAsNonRoot<span style=color:#f92672>=</span>true<span style=color:#f92672>)</span>, seccompProfile <span style=color:#f92672>(</span>pod or container <span style=color:#e6db74>&#34;grafana-core&#34;</span> must set securityContext.seccompProfile.type to <span style=color:#e6db74>&#34;RuntimeDefault&#34;</span> or <span style=color:#e6db74>&#34;Localhost&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>deployment.apps/grafana created
</span></span><span style=display:flex><span>Warning: would violate PodSecurity <span style=color:#e6db74>&#34;restricted:latest&#34;</span>: allowPrivilegeEscalation !<span style=color:#f92672>=</span> false <span style=color:#f92672>(</span>container <span style=color:#e6db74>&#34;prometheus&#34;</span> must set securityContext.allowPrivilegeEscalation<span style=color:#f92672>=</span>false<span style=color:#f92672>)</span>, unrestricted capabilities <span style=color:#f92672>(</span>container <span style=color:#e6db74>&#34;prometheus&#34;</span> must set securityContext.capabilities.drop<span style=color:#f92672>=[</span><span style=color:#e6db74>&#34;ALL&#34;</span><span style=color:#f92672>])</span>, runAsNonRoot !<span style=color:#f92672>=</span> true <span style=color:#f92672>(</span>pod or container <span style=color:#e6db74>&#34;prometheus&#34;</span> must set securityContext.runAsNonRoot<span style=color:#f92672>=</span>true<span style=color:#f92672>)</span>, seccompProfile <span style=color:#f92672>(</span>pod or container <span style=color:#e6db74>&#34;prometheus&#34;</span> must set securityContext.seccompProfile.type to <span style=color:#e6db74>&#34;RuntimeDefault&#34;</span> or <span style=color:#e6db74>&#34;Localhost&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>deployment.apps/prometheus created
</span></span></code></pre></div><h3 id=kubectl-get-all>kubectl get all</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>❯ kubectl get all -n cilium-monitoring 
</span></span><span style=display:flex><span>NAME                              READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>pod/grafana-6f4755f98c-8c7sg      1/1     Running   <span style=color:#ae81ff>0</span>          57s
</span></span><span style=display:flex><span>pod/prometheus-67fdcf4796-vc8hd   1/1     Running   <span style=color:#ae81ff>0</span>          57s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>    AGE
</span></span><span style=display:flex><span>service/grafana      ClusterIP   10.102.147.187   &lt;none&gt;        3000/TCP   57s
</span></span><span style=display:flex><span>service/prometheus   ClusterIP   10.104.8.139     &lt;none&gt;        9090/TCP   57s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>deployment.apps/grafana      1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           57s
</span></span><span style=display:flex><span>deployment.apps/prometheus   1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           57s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                    DESIRED   CURRENT   READY   AGE
</span></span><span style=display:flex><span>replicaset.apps/grafana-6f4755f98c      <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>       57s
</span></span><span style=display:flex><span>replicaset.apps/prometheus-67fdcf4796   <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>       57s
</span></span></code></pre></div><h3 id=change-service-type-to-loadbalancer>Change service type to LoadBalancer</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>❯ kubectl patch svc prometheus -n cilium-monitoring -p <span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;type&#34;: &#34;LoadBalancer&#34;}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>❯ kubectl patch svc grafana -n cilium-monitoring -p <span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;type&#34;: &#34;LoadBalancer&#34;}}&#39;</span>
</span></span></code></pre></div><p>Now <code>TYPE</code> is <code>LoadBalancer</code> and <code>EXTERNAL-IP</code> is assigned for each service</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>❯ kubectl get svc -n cilium-monitoring
</span></span><span style=display:flex><span>NAME         TYPE           CLUSTER-IP       EXTERNAL-IP     PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>          AGE
</span></span><span style=display:flex><span>grafana      LoadBalancer   10.102.147.187   192.168.0.131   3000:32230/TCP   19m
</span></span><span style=display:flex><span>prometheus   LoadBalancer   10.104.8.139     192.168.0.130   9090:31588/TCP   19m
</span></span></code></pre></div><h3 id=access-grafana-web-page>Access Grafana web page</h3><p><img src=/images/2024/02/2024-02-20-Prometheus-with-LoadBalancer.png alt></p><h3 id=access-grafana-web-page-1>Access Grafana web page</h3><p><img src=/images/2024/02/2024-02-20-Grafana-with-LoadBalancer.png alt></p><h3 id=add-prometheus-as-a-data-source>Add Prometheus as a data source</h3><p><img src=/images/2024/02/2024-02-20-Add-Prometheus-data-source.png alt></p><h2 id=enable-metrics-from-cilium-and-hubble>Enable metrics from Cilium and Hubble</h2><ul><li><code>Cilium</code>, <code>Hubble</code>, and <code>Cilium Operator</code> do not expose metrics by default.</li><li><code>9962</code>, <code>9965</code>, and <code>9963</code></li></ul><h3 id=enable-metrics-during-installation-with-helm>Enable metrics during installation with helm</h3><p>Add these options to <code>helm install</code> command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>   --set prometheus.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>   --set operator.prometheus.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>   --set hubble.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>   --set hubble.metrics.enableOpenMetrics<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>   --set hubble.metrics.enabled<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip\,source_namespace\,source_workload\,destination_ip\,destination_namespace\,destination_workload\,traffic_direction}&#34;</span>
</span></span></code></pre></div><h3 id=update-existing-cilium-helm-release>Update existing Cilium helm release</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>helm upgrade cilium cilium/cilium --version 1.15.1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>   --namespace kube-system <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>   --reuse-values <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>   --set prometheus.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>   --set operator.prometheus.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>   --set hubble.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>   --set hubble.metrics.enableOpenMetrics<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>   --set hubble.metrics.enabled<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip\,source_namespace\,source_workload\,destination_ip\,destination_namespace\,destination_workload\,traffic_direction}&#34;</span>  
</span></span></code></pre></div><h2 id=check-prometheus-targets>Check Prometheus Targets</h2><p>Some targets are already configured</p><p><img src=/images/2024/02/2024-02-20-Prometheus-targets.png alt></p><h2 id=grafana-dashboard-for-cilium-metrics>Grafana dashboard for Cilium metrics</h2><p><img src=/images/2024/02/2024-02-20-Grafana-dashboards-for-Cilium.png alt></p></content><p><a href=https://cychong47.github.io/tags/til/>#Til</a>
<a href=https://cychong47.github.io/tags/cilium/>#Cilium</a>
<a href=https://cychong47.github.io/tags/prometheus/>#Prometheus</a>
<a href=https://cychong47.github.io/tags/grafana/>#Grafana</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>