<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Calico CNI (draft) | Keep calm and Write something</title><meta name=title content="Calico CNI (draft)"><meta name=description content="Getting started with Calico on Kubernetes


Calico를 사용하는 경우 kubelet의 실행 옵션 중 --network-plugin=cni와 같이 변경된다.


kube-controller-manager의 실행 옵션 중 --allocate-node-cidrs=false 로 역시 변경된다. 이는 CNI(여기서는 Calico의 IPAM)에서 IP 주소를 할당하기 때문


Pod 내 route table에서는 host의 link local address를 default route로 사용한다.


Pod가 갖는 eth0 interface는 root(혹은 default) namespace에 존재하는 &lsquo;cali&rsquo;로 시작하는 interface와 veh pair 관계를 갖는다.

veth pairs는 아래 설명과 같이 서로 연결된 두 개의 interface를 의미하는데 한쪽으로 들어가면 연결된 다른 인터페이스로 나온다. 즉 pod의 eth0 interface를 통해 패킷을 전송하면 host의 cali interface로 나와 커널의 라우팅 혹은 iptable 처리를 받는다.
https://www.fir3net.com/Networking/Terms-and-Concepts/virtual-networking-devices-tun-tap-and-veth-pairs-explained.html




What goes in one end will come out the other."><meta name=keywords content="container,kubernetes,cni,calico,network,"><meta property="og:url" content="https://cychong47.github.io/post/2019/calico-cni-1/"><meta property="og:site_name" content="Keep calm and Write something"><meta property="og:title" content="Calico CNI (draft)"><meta property="og:description" content="Getting started with Calico on Kubernetes Calico를 사용하는 경우 kubelet의 실행 옵션 중 --network-plugin=cni와 같이 변경된다.
kube-controller-manager의 실행 옵션 중 --allocate-node-cidrs=false 로 역시 변경된다. 이는 CNI(여기서는 Calico의 IPAM)에서 IP 주소를 할당하기 때문
Pod 내 route table에서는 host의 link local address를 default route로 사용한다.
Pod가 갖는 eth0 interface는 root(혹은 default) namespace에 존재하는 ‘cali’로 시작하는 interface와 veh pair 관계를 갖는다.
veth pairs는 아래 설명과 같이 서로 연결된 두 개의 interface를 의미하는데 한쪽으로 들어가면 연결된 다른 인터페이스로 나온다. 즉 pod의 eth0 interface를 통해 패킷을 전송하면 host의 cali interface로 나와 커널의 라우팅 혹은 iptable 처리를 받는다. https://www.fir3net.com/Networking/Terms-and-Concepts/virtual-networking-devices-tun-tap-and-veth-pairs-explained.html What goes in one end will come out the other."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-08-18T15:20:01+09:00"><meta property="article:modified_time" content="2019-08-22T15:04:20+00:00"><meta property="article:tag" content="Container"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Cni"><meta property="article:tag" content="Calico"><meta property="article:tag" content="Network"><meta name=twitter:card content="summary"><meta name=twitter:title content="Calico CNI (draft)"><meta name=twitter:description content="Getting started with Calico on Kubernetes Calico를 사용하는 경우 kubelet의 실행 옵션 중 --network-plugin=cni와 같이 변경된다.
kube-controller-manager의 실행 옵션 중 --allocate-node-cidrs=false 로 역시 변경된다. 이는 CNI(여기서는 Calico의 IPAM)에서 IP 주소를 할당하기 때문
Pod 내 route table에서는 host의 link local address를 default route로 사용한다.
Pod가 갖는 eth0 interface는 root(혹은 default) namespace에 존재하는 ‘cali’로 시작하는 interface와 veh pair 관계를 갖는다.
veth pairs는 아래 설명과 같이 서로 연결된 두 개의 interface를 의미하는데 한쪽으로 들어가면 연결된 다른 인터페이스로 나온다. 즉 pod의 eth0 interface를 통해 패킷을 전송하면 host의 cali interface로 나와 커널의 라우팅 혹은 iptable 처리를 받는다. https://www.fir3net.com/Networking/Terms-and-Concepts/virtual-networking-devices-tun-tap-and-veth-pairs-explained.html What goes in one end will come out the other."><meta itemprop=name content="Calico CNI (draft)"><meta itemprop=description content="Getting started with Calico on Kubernetes Calico를 사용하는 경우 kubelet의 실행 옵션 중 --network-plugin=cni와 같이 변경된다.
kube-controller-manager의 실행 옵션 중 --allocate-node-cidrs=false 로 역시 변경된다. 이는 CNI(여기서는 Calico의 IPAM)에서 IP 주소를 할당하기 때문
Pod 내 route table에서는 host의 link local address를 default route로 사용한다.
Pod가 갖는 eth0 interface는 root(혹은 default) namespace에 존재하는 ‘cali’로 시작하는 interface와 veh pair 관계를 갖는다.
veth pairs는 아래 설명과 같이 서로 연결된 두 개의 interface를 의미하는데 한쪽으로 들어가면 연결된 다른 인터페이스로 나온다. 즉 pod의 eth0 interface를 통해 패킷을 전송하면 host의 cali interface로 나와 커널의 라우팅 혹은 iptable 처리를 받는다. https://www.fir3net.com/Networking/Terms-and-Concepts/virtual-networking-devices-tun-tap-and-veth-pairs-explained.html What goes in one end will come out the other."><meta itemprop=datePublished content="2019-08-18T15:20:01+09:00"><meta itemprop=dateModified content="2019-08-22T15:04:20+00:00"><meta itemprop=wordCount content="492"><meta itemprop=keywords content="Container,Kubernetes,Cni,Calico,Network"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>Keep calm and Write something</h2></a><nav><a href=/post/>Post</a>
<a href=/page/>Page</a>
<a href=/series/>Series</a>
<a href=/tags/>Tag</a>
<a href=/archive/>Archive</a>
<a href=/search/>Search</a></nav></header><main><content><h2 id=getting-started-with-calico-on-kubernetes><a href=https://www.dasblinkenlichten.com/getting-started-with-calico-on-kubernetes/>Getting started with Calico on Kubernetes</a></h2><ul><li><p>Calico를 사용하는 경우 kubelet의 실행 옵션 중 <code>--network-plugin=cni</code>와 같이 변경된다.</p></li><li><p>kube-controller-manager의 실행 옵션 중 <code>--allocate-node-cidrs=false</code> 로 역시 변경된다. 이는 CNI(여기서는 Calico의 IPAM)에서 IP 주소를 할당하기 때문</p></li><li><p>Pod 내 route table에서는 host의 link local address를 default route로 사용한다.</p></li><li><p>Pod가 갖는 eth0 interface는 root(혹은 default) namespace에 존재하는 &lsquo;cali&rsquo;로 시작하는 interface와 veh pair 관계를 갖는다.</p><ul><li>veth pairs는 아래 설명과 같이 서로 연결된 두 개의 interface를 의미하는데 한쪽으로 들어가면 연결된 다른 인터페이스로 나온다. 즉 pod의 eth0 interface를 통해 패킷을 전송하면 host의 cali interface로 나와 커널의 라우팅 혹은 iptable 처리를 받는다.</li><li><a href=https://www.fir3net.com/Networking/Terms-and-Concepts/virtual-networking-devices-tun-tap-and-veth-pairs-explained.html>https://www.fir3net.com/Networking/Terms-and-Concepts/virtual-networking-devices-tun-tap-and-veth-pairs-explained.html</a></li></ul></li></ul><blockquote><p>What goes in one end will come out the other.</p></blockquote><p><img src=https://www.fir3net.com/images/articles/virtual-devices-all-4.png alt></p><h2 id=calico-and-kubernetes-series-1-to-4><a href=https://rendoaw.github.io/2017/10/Calico-and-Kubernetes-part-1>Calico and Kubernetes Series 1 to 4</a></h2><p>kubernetes를 설치하는 방법부터 Calico 설치 그리고 sample application을 이용해서 calico를 이용한 전반적인 네트워킹을 친절하고 상세하게 설명.</p><ul><li>k8s 설치 방법 : kubeadm을 이용해서 설치할 수 있다.<ul><li><a href=https://kubenetes.io/docs/setup/independent/install-kubeadm>https://kubenetes.io/docs/setup/independent/install-kubeadm</a></li><li><code>sudo systemctl start docker ; sudo systemctl enable docker</code></li><li>Virtualbox 등을 사용해서 설치하는 경우 최소 core 2개 이상은 할당해야 함. 그렇지 않으면 kubeadm 실행할 때 core 부족을 이유로 에러 발생. 추가로 swap 도 꺼야 함 <code>sudo swapoff -a</code></li><li>Ubuntu 에 kubenetes 설치하는 것은 (<a href=https://www.linuxtechi.com/install-configure-kubernetes-ubuntu-18-04-ubuntu-18-10/>https://www.linuxtechi.com/install-configure-kubernetes-ubuntu-18-04-ubuntu-18-10/</a> 참고.</li></ul></li><li>master node를 worker node로 사용하려면 &lsquo;kubectl taint&rsquo; 명령을 사용하면 된다<ul><li><code>kubectl taint nodes --all node-role,kubernetes.io/master-</code></li></ul></li><li>일반 사용자도 kubectl 을 사용하게 하려면 <code>/etc/kubenetes/admin.conf' 사용자 계정 아래 </code>$HOME/.kube/config` 파일로 복사하고 권한을 사용자로 주면 된다.<ul><li><code>sudo cp -i /etc/kubenetes/admin.conf $HOME/.kube/config ; sudo chown $(id -u):$(id -g) $HOME/.kube/config</code></li></ul></li><li>Calico 관련 설정 내용을 확인하려면 <code>kube-system</code> namespace에서 동작하고 있는 <code>calicoctl</code> pod의 <code>calicoctl</code> 을 사용한다.<ul><li><code>kubectl exec -ti -n kube-system calicoctl -- /calicoctl get profiles -o wide</code></li><li><code>kubectl exec -ti -n kube-system calicoctl -- /calicoctl get -o yaml ippool</code><ul><li><code>nat-outging: true</code> container에서 외부로 향하는 패킷 중 목적지가 calico CIDR에 속하지 않는 경우 NAT를 수행한다는 의미. 자세한 내용은 <code>iptables -L -t nat -n</code> 명령에서 확인할 수 있음</li></ul></li><li>ippool을 추가하려면 <code>kind: ipPool</code>을 갖는 yaml 파일을 만들어 calico 명령으로 적용한다.<ul><li>calicoctl pod에서 실행해야 하는데 yaml 파일을 해당 pod 내에서 만들어서 적용해야 하므로 calicoctl pod에 ssh로 접속한 후 YAML 파일 만들어 <code>calicoctl create -f XXX.yaml</code> 명령으로 적용한다.</li></ul></li><li>2개 이상의 ippool을 만든 경우 특정 pod가 특정 subnet에서 ip를 할당받도록 하려면 annotation 을 이용해서 pod 생성시 calico subnet을 지정한다.<ul><li><code>annotations: "cni.projectcalico.org/ipv4pools": "[\"10.91.1.0/24\"]"</code></li></ul></li></ul></li><li>다목적 시험용 sshd pod는 이걸 사용<ul><li><code>kubectl run sushi-1 --image=rastasheep/ubuntu-sshd:16.04</code></li><li>단 2017년 글이라 그런지 <code>kubectl run</code> 대신 <code>kubectl create</code>를 사용하라고 경고가 나온다</li><li>추가로 패키지를 몇 개 설치할 섯. <code>apt-get update ; apt-get install iproute2 inetutils-ping traceroute</code></li></ul></li><li>container내 eth0 interface의 IP는 /32로 host의 <code>cali</code>로 시작하는 veth pair 관계를 갖는다.<ul><li>pod내에서 <code>ip -d link</code> 명령의 결과에 나오는 interface 이름 정보를 통해 Veth pair 인터페이스가 어떤 것인지 확인할 수 있다. 예를 들어 pod 내에서 확인한 정보가 <code>eth0@if5</code>면 이 pod의 eth0는 host에서 5번째 interface라는 것을 알 수 있다.</li></ul></li><li>특정 pod가 위치할 node를 지정하기 위해 node에 label을 지정하려면<ul><li><code>kubectl label nodes NODE-NAME node_id=NODE-LABEL</code></li></ul></li><li>Calico의 bop 기능을 사용하려면 &ldquo;kind: bgpPeer"인 YAML 파일을 만들어 적용한다. (calicoctl pod 내에서 작업)<ul><li><code>calicoctl create -f bgp.yaml</code></li><li><code>calicoctl get -o yaml bgppeer</code></li><li><code>calicoctl node status</code></li><li>여러 노드들이 동일한 bgp 정보를 adversize하여 특정 pod의 subnet이 여러 node에서 수신하도록 외부에 adversize될 수도 있음. <strong>확인 필요</strong></li></ul></li></ul></content><p><a href=https://cychong47.github.io/tags/container/>#Container</a>
<a href=https://cychong47.github.io/tags/kubernetes/>#Kubernetes</a>
<a href=https://cychong47.github.io/tags/cni/>#Cni</a>
<a href=https://cychong47.github.io/tags/calico/>#Calico</a>
<a href=https://cychong47.github.io/tags/network/>#Network</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>