<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Replace NodePort with ClsuterIP - Thx to Traefik | Keep calm and Write something</title><meta name=title content="Replace NodePort with ClsuterIP - Thx to Traefik"><meta name=description content="Traefik을 이용한 Ingress/Ingress Controller를 이용해서 nginx 기반 Pod를 cluster 외부에서 접속할 수 있도록 설정했는데 곰곰히 생각해 보니 그렇다면 nginx service에 굳이 NodePort를 사용해야 하나 라는 생각이 들었다. 이제 외부로부터의 요청은 든든한 Traefik이 처리해 줄 테니 직접 각 pod가 서비스를 NodePort를 이용해서 외부에 오픈할 필요가 없어 보였다.
이를 위해 기존에 사용하던 nginx의 value 파일을 다음과 같이 수정했다. NodePort를 위해 필요했던 정보들이 사라지고, 수신하고 싶은 Port만 지정하면 되니설정 파일이 무척 깔끔해졌다.
service:
        #  type: NodePort
        #  targetPort: 80               # container app. itself
        #  port: 8099                   # pod
        #  nodePort: 8099               # cluster-wise
        #  externalTrafficPolicy: Local
        #  externalIPs: [192.168.0.100]
  type: ClusterIP
  port: 80
변경된 value 파일을 이용해서 다시 deploy."><meta name=keywords content="Traefik,"><meta property="og:url" content="https://cychong47.github.io/post/2021/2021-03-31-change-nodeport-to-clusterip/"><meta property="og:site_name" content="Keep calm and Write something"><meta property="og:title" content="Replace NodePort with ClsuterIP - Thx to Traefik"><meta property="og:description" content="Traefik을 이용한 Ingress/Ingress Controller를 이용해서 nginx 기반 Pod를 cluster 외부에서 접속할 수 있도록 설정했는데 곰곰히 생각해 보니 그렇다면 nginx service에 굳이 NodePort를 사용해야 하나 라는 생각이 들었다. 이제 외부로부터의 요청은 든든한 Traefik이 처리해 줄 테니 직접 각 pod가 서비스를 NodePort를 이용해서 외부에 오픈할 필요가 없어 보였다.
이를 위해 기존에 사용하던 nginx의 value 파일을 다음과 같이 수정했다. NodePort를 위해 필요했던 정보들이 사라지고, 수신하고 싶은 Port만 지정하면 되니설정 파일이 무척 깔끔해졌다.
service: # type: NodePort # targetPort: 80 # container app. itself # port: 8099 # pod # nodePort: 8099 # cluster-wise # externalTrafficPolicy: Local # externalIPs: [192.168.0.100] type: ClusterIP port: 80 변경된 value 파일을 이용해서 다시 deploy."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-04-03T22:00:00+09:00"><meta property="article:modified_time" content="2021-04-03T22:00:00+09:00"><meta property="article:tag" content="Traefik"><meta property="og:see_also" content="https://cychong47.github.io/post/2021/2021-05-08-access-control-with-traefik-middleware/"><meta property="og:see_also" content="https://cychong47.github.io/post/2021/2021-03-31-setup-ingress-with-traefik/"><meta property="og:see_also" content="https://cychong47.github.io/post/2021/2021-03-30-install-traefik-with-helm/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Replace NodePort with ClsuterIP - Thx to Traefik"><meta name=twitter:description content="Traefik을 이용한 Ingress/Ingress Controller를 이용해서 nginx 기반 Pod를 cluster 외부에서 접속할 수 있도록 설정했는데 곰곰히 생각해 보니 그렇다면 nginx service에 굳이 NodePort를 사용해야 하나 라는 생각이 들었다. 이제 외부로부터의 요청은 든든한 Traefik이 처리해 줄 테니 직접 각 pod가 서비스를 NodePort를 이용해서 외부에 오픈할 필요가 없어 보였다.
이를 위해 기존에 사용하던 nginx의 value 파일을 다음과 같이 수정했다. NodePort를 위해 필요했던 정보들이 사라지고, 수신하고 싶은 Port만 지정하면 되니설정 파일이 무척 깔끔해졌다.
service: # type: NodePort # targetPort: 80 # container app. itself # port: 8099 # pod # nodePort: 8099 # cluster-wise # externalTrafficPolicy: Local # externalIPs: [192.168.0.100] type: ClusterIP port: 80 변경된 value 파일을 이용해서 다시 deploy."><meta itemprop=name content="Replace NodePort with ClsuterIP - Thx to Traefik"><meta itemprop=description content="Traefik을 이용한 Ingress/Ingress Controller를 이용해서 nginx 기반 Pod를 cluster 외부에서 접속할 수 있도록 설정했는데 곰곰히 생각해 보니 그렇다면 nginx service에 굳이 NodePort를 사용해야 하나 라는 생각이 들었다. 이제 외부로부터의 요청은 든든한 Traefik이 처리해 줄 테니 직접 각 pod가 서비스를 NodePort를 이용해서 외부에 오픈할 필요가 없어 보였다.
이를 위해 기존에 사용하던 nginx의 value 파일을 다음과 같이 수정했다. NodePort를 위해 필요했던 정보들이 사라지고, 수신하고 싶은 Port만 지정하면 되니설정 파일이 무척 깔끔해졌다.
service: # type: NodePort # targetPort: 80 # container app. itself # port: 8099 # pod # nodePort: 8099 # cluster-wise # externalTrafficPolicy: Local # externalIPs: [192.168.0.100] type: ClusterIP port: 80 변경된 value 파일을 이용해서 다시 deploy."><meta itemprop=datePublished content="2021-04-03T22:00:00+09:00"><meta itemprop=dateModified content="2021-04-03T22:00:00+09:00"><meta itemprop=wordCount content="204"><meta itemprop=keywords content="Traefik"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#fafafa;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>Keep calm and Write something</h2></a><nav><a href=/post/>Post</a>
<a href=/page/>Page</a>
<a href=/series/>Series</a>
<a href=/tags/>Tag</a>
<a href=/archive/>Archive</a>
<a href=/search/>Search</a></nav></header><main><content><p>Traefik을 이용한 Ingress/Ingress Controller를 이용해서 nginx 기반 Pod를 cluster 외부에서 접속할 수 있도록 설정했는데 곰곰히 생각해 보니 그렇다면 nginx service에 굳이 <code>NodePort</code>를 사용해야 하나 라는 생각이 들었다. 이제 외부로부터의 요청은 든든한 Traefik이 처리해 줄 테니 직접 각 pod가 서비스를 NodePort를 이용해서 외부에 오픈할 필요가 없어 보였다.</p><p>이를 위해 기존에 사용하던 nginx의 value 파일을 다음과 같이 수정했다. NodePort를 위해 필요했던 정보들이 사라지고, 수신하고 싶은 Port만 지정하면 되니설정 파일이 무척 깔끔해졌다.</p><pre tabindex=0><code>service:
        #  type: NodePort
        #  targetPort: 80               # container app. itself
        #  port: 8099                   # pod
        #  nodePort: 8099               # cluster-wise
        #  externalTrafficPolicy: Local
        #  externalIPs: [192.168.0.100]
  type: ClusterIP
  port: 80
</code></pre><p>변경된 value 파일을 이용해서 다시 deploy.</p><pre tabindex=0><code>$ kubectl get pod -o wide |grep podcast
podcast-nginx-659bcb6485-dxqm5   1/1     Running     0          2m29s   10.244.51.105   mini1   &lt;none&gt;           &lt;none&gt;
</code></pre><p>Service 정보에서 <code>EXTERNAL-IP</code> 항목이 이제 <code>none</code>으로 나오고, <code>TYPE</code>도 <code>Cluster IP</code>로 변경되었다.</p><pre tabindex=0><code>$ kubectl get svc
NAME            TYPE        CLUSTER-IP       EXTERNAL-IP     PORT(S)                                     AGE
...
podcast-nginx   ClusterIP   10.96.100.155    &lt;none&gt;          80/TCP                                      2m20s
...
</code></pre><p>다만 IngressRoute 규칙은 다시 설정했어야 하는데, ingress rule의 port정보를 기존에 8099에서 80으로 변경한 후에 helm을 이용해서 backend service/deployment를 설치했는데도 제대로 동작하지 않아서 다시 IngressRoute를 적용했더니 그제서야 정상 동작 했다는.</p><p><img src=/images/2021/04/2021-04-03-traefik-with-clusterip.png alt></p><p><img src=/images/2021/04/2021-04-03-traefik-service-endpoint.png alt></p><p>아무튼 이제 Traefik으로 처리하는 서비스는 더 이상 외부에서 port를 이용해서 서비스되지 않도록 했다. 이제 공유기에 설정했던 port forwarding 내용도 하나 줄일 수 있겠네.
<img src=/images/2021/04/2021-04-03-legacy-port-based-not-working-anymore.png alt></p></content><p><a href=https://cychong47.github.io/tags/traefik/>#Traefik</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>